<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title><![CDATA[kiya's pigsty]]></title>
  <subtitle><![CDATA[No Further Delay!]]></subtitle>
  <link href="/atom.xml" rel="self"/>
  <link href="http://kiya-z.github.io/"/>
  <updated>2015-11-22T16:48:45.390Z</updated>
  <id>http://kiya-z.github.io/</id>
  
  <author>
    <name><![CDATA[Kiya]]></name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title><![CDATA[解析 dex 文件结构 - 索引区和数据区（三） - ClassDefs]]></title>
    <link href="http://kiya-z.github.io/2015/11/21/parse-dex-file-part-classdefs/"/>
    <id>http://kiya-z.github.io/2015/11/21/parse-dex-file-part-classdefs/</id>
    <published>2015-11-21T15:17:50.000Z</published>
    <updated>2015-11-22T16:48:45.390Z</updated>
    <content type="html"><![CDATA[<p><img src="http://7xo976.com1.z0.glb.clouddn.com/images/github-io/Android/dex-file-general-structure-3.png" alt="part-class-defs"></p>
<a id="more"></a>
<p>ClassDefs 表示某个类的全部信息，包括类类型、访问权限、父类、接口、源文件名、注解和代码等信息。<br>ClassDefs 的大小和文件偏移在 DexHeader 和 map_list 中都有指定。</p>
<hr>
<h1 id="结构">结构</h1><p>ClassDefs 以4字节对齐，即总大小为 4 * 8 * ClassDefsSize .</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> Direct-mapped <span class="string">"class_def_item"</span>.</span><br><span class="line"> <span class="keyword">*</span>/</span><br><span class="line">struct DexClassDef &#123;</span><br><span class="line">    u4  classIdx;           /<span class="keyword">*</span> 指向 typeIds 的索引，表示类的类型 <span class="keyword">*</span>/</span><br><span class="line">    u4  accessFlags;        /<span class="keyword">*</span> 类的访问标识<span class="keyword">*</span>/</span><br><span class="line">    u4  superclassIdx;      /<span class="keyword">*</span> 指向 typeIds 的索引，表示父类类型 <span class="keyword">*</span>/</span><br><span class="line">    u4  interfacesOff;      /<span class="keyword">*</span> 指向 DexTypeList 的文件偏移，表示接口<span class="keyword">*</span>/</span><br><span class="line">    u4  sourceFileIdx;      /<span class="keyword">*</span> 指向 stringIds 的索引，表示源文件名 <span class="keyword">*</span>/</span><br><span class="line">    u4  annotationsOff;     /<span class="keyword">*</span> 指向 annotations_directory_item 的文件偏移，表示注解<span class="keyword">*</span>/</span><br><span class="line">    u4  classDataOff;       /<span class="keyword">*</span> 指向 class_data_item 的文件偏移<span class="keyword">*</span>/</span><br><span class="line">    u4  staticValuesOff;    /<span class="keyword">*</span> 指向 DexEncodedArray 的文件偏移<span class="keyword">*</span>/</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="classIdx">classIdx</h2><p>指向 typeIds 的索引，类类型，必须是一个类类型而不是数组或者基本类型。</p>
<hr>
<h2 id="accessFlags">accessFlags</h2><p>类的访问标识，如 public、final 等，常量定义如下，包括类、字段和方法的访问标识：</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Value</th>
<th>For Classes (and InnerClass annotations)</th>
<th>For Fields</th>
<th>For Methods</th>
</tr>
</thead>
<tbody>
<tr>
<td>ACC_PUBLIC</td>
<td>0x1</td>
<td>public: visible everywhere</td>
<td>public: visible everywhere</td>
<td>public: visible everywhere</td>
</tr>
<tr>
<td>ACC_PRIVATE</td>
<td>0x2</td>
<td>* private: only visible to defining class</td>
<td>private: only visible to defining class</td>
<td>private: only visible to defining class</td>
</tr>
<tr>
<td>ACC_PROTECTED</td>
<td>0x4</td>
<td>* protected: visible to package and subclasses</td>
<td>protected: visible to package and subclasses</td>
<td>protected: visible to package and subclasses</td>
</tr>
<tr>
<td>ACC_STATIC</td>
<td>0x8</td>
<td>* static: is not constructed with an outer this reference</td>
<td>static: global to defining class</td>
<td>static: does not take a this argument</td>
</tr>
<tr>
<td>ACC_FINAL</td>
<td>0x10</td>
<td>final: not subclassable</td>
<td>final: immutable after construction</td>
<td>final: not overridable</td>
</tr>
<tr>
<td>ACC_SYNCHRONIZED</td>
<td>0x20</td>
<td></td>
<td></td>
<td>synchronized: associated lock automatically acquired around call to this method.Note: This is only valid to set when ACC_NATIVE is also set.</td>
</tr>
<tr>
<td>ACC_BRIDGE</td>
<td>0x40</td>
<td></td>
<td></td>
<td>bridge method, added automatically by compiler as a type-safe bridge</td>
</tr>
<tr>
<td>ACC_VOLATILE</td>
<td>0x40</td>
<td></td>
<td>volatile: special access rules to help with thread safety</td>
<td></td>
</tr>
<tr>
<td>ACC_TRANSIENT</td>
<td>0x80</td>
<td></td>
<td>transient: not to be saved by default serialization</td>
<td></td>
</tr>
<tr>
<td>ACC_VARARGS</td>
<td>0x80</td>
<td></td>
<td></td>
<td>last argument should be treated as a “rest” argument by compiler</td>
</tr>
<tr>
<td>ACC_NATIVE</td>
<td>0x100</td>
<td></td>
<td></td>
<td>native: implemented in native code</td>
</tr>
<tr>
<td>ACC_INTERFACE</td>
<td>0x200</td>
<td>interface: multiply-implementable abstract class</td>
<td></td>
<td></td>
</tr>
<tr>
<td>ACC_ABSTRACT</td>
<td>0x400</td>
<td>abstract: not directly instantiable</td>
<td></td>
<td>abstract: unimplemented by this class</td>
</tr>
<tr>
<td>ACC_STRICT</td>
<td>0x800</td>
<td></td>
<td></td>
<td>strictfp: strict rules for floating-point arithmetic</td>
</tr>
<tr>
<td>ACC_SYNTHETIC</td>
<td>0x1000</td>
<td>not directly defined in source code</td>
<td>not directly defined in source code</td>
<td>not directly defined in source code</td>
</tr>
<tr>
<td>ACC_ANNOTATION</td>
<td>0x2000</td>
<td>declared as an annotation class</td>
<td></td>
<td></td>
</tr>
<tr>
<td>ACC_ENUM</td>
<td>0x4000</td>
<td>declared as an enumerated type</td>
<td>declared as an enumerated value</td>
<td></td>
</tr>
<tr>
<td>(unused)</td>
<td>0x8000</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>ACC_CONSTRUCTOR</td>
<td>0x10000</td>
<td></td>
<td></td>
<td>constructor method (class or instance initializer)</td>
</tr>
<tr>
<td>ACC_DECLARED_SYNCHRONIZED</td>
<td>0x20000</td>
<td></td>
<td></td>
<td>declared synchronized. Note: This has no effect on execution (other than in reflection of this flag, per se).</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="superclassIdx">superclassIdx</h2><p>指向 typeIds 的索引，父类类型；如果没有父类值为 NO_INDEX . 注意 NO_INDEX 值不是0，因为 0 是一个合法的索引，而且 NO_INDEX 是以 uleb128p1 编码的。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uint NO_INDEX = <span class="number">0xffffffff</span>;    <span class="comment">// == -1 if treated as a signed int</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="interfacesOff">interfacesOff</h2><p>指向 DexTypeList 的文件偏移（在数据段中），表示接口；如果没有接口此值为 0 。<br>DexTypeList 中的值必须是类类型，并且没有重复。</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> Direct-mapped <span class="string">"type_list"</span>.</span><br><span class="line"> <span class="keyword">*</span>/</span><br><span class="line">struct DexTypeList &#123;</span><br><span class="line">    u4  size;               /<span class="keyword">*</span> DexTypeItem的个数 <span class="keyword">*</span>/</span><br><span class="line">    DexTypeItem list[1];    /<span class="keyword">*</span> DexTypeItem的内容 <span class="keyword">*</span>/</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">/<span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> Direct-mapped <span class="string">"type_item"</span>.</span><br><span class="line"> <span class="keyword">*</span>/</span><br><span class="line">struct DexTypeItem &#123;</span><br><span class="line">    u2  typeIdx;            /<span class="keyword">*</span> 指向 typeIds 的索引 <span class="keyword">*</span>/</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="sourceFileIdx">sourceFileIdx</h2><p>指向 stringIds 的索引，表示本类所在的源文件名，如果没有这个信息值为 NO_INDEX</p>
<hr>
<h2 id="annotationsOff">annotationsOff</h2><p>指向 annotations_directory_item 的文件偏移，表示注解；如果没有注解，此值为 0 。</p>
<h3 id="annotations_directory_item">annotations_directory_item</h3><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> Direct-mapped <span class="string">"annotations_directory_item"</span>.</span><br><span class="line"> <span class="keyword">*</span>/</span><br><span class="line">struct DexAnnotationsDirectoryItem &#123;</span><br><span class="line">    u4  classAnnotationsOff;  /<span class="keyword">*</span> 指向 DexAnnotationSetItem 的文件偏移，若无，值为0<span class="keyword">*</span>/</span><br><span class="line">    u4  fieldsSize;           /<span class="keyword">*</span> DexFieldAnnotationsItem 的个数<span class="keyword">*</span>/</span><br><span class="line">    u4  methodsSize;          /<span class="keyword">*</span> DexMethodAnnotationsItem 的个数<span class="keyword">*</span>/</span><br><span class="line">    u4  parametersSize;       /<span class="keyword">*</span> DexParameterAnnotationsItem 的个数<span class="keyword">*</span>/</span><br><span class="line">    /<span class="keyword">*</span> followed by DexFieldAnnotationsItem[fieldsSize] <span class="keyword">*</span>/</span><br><span class="line">    /<span class="keyword">*</span> followed by DexMethodAnnotationsItem[methodsSize] <span class="keyword">*</span>/</span><br><span class="line">    /<span class="keyword">*</span> followed by DexParameterAnnotationsItem[parametersSize] <span class="keyword">*</span>/</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="annotation_set_item">annotation_set_item</h4><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> Direct-mapped <span class="string">"annotation_set_item"</span>.</span><br><span class="line"> <span class="keyword">*</span>/</span><br><span class="line">struct DexAnnotationSetItem &#123;</span><br><span class="line">    u4  size;               /<span class="keyword">*</span> DexAnnotationItem 的个数<span class="keyword">*</span>/</span><br><span class="line">    u4  entries[1];         /<span class="keyword">*</span> DexAnnotationItem 的内容<span class="keyword">*</span>/</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">/<span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> Direct-mapped <span class="string">"annotation_item"</span>.</span><br><span class="line"> <span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> NOTE: this structure is byte-aligned.</span><br><span class="line"> <span class="keyword">*</span>/</span><br><span class="line">struct DexAnnotationItem &#123;</span><br><span class="line">    u1  visibility;     /<span class="keyword">*</span> 可见性 <span class="keyword">*</span>/</span><br><span class="line">    u1  annotation[1];  /<span class="keyword">*</span> 以 encoded_annotation 格式编码 <span class="keyword">*</span>/</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>visibility 定义:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>VISIBILITY_BUILD</td>
<td>0x00</td>
<td>编译时可见</td>
</tr>
<tr>
<td>VISIBILITY_RUNTIME</td>
<td>0x01</td>
<td>运行时可见</td>
</tr>
<tr>
<td>VISIBILITY_SYSTEM</td>
<td>0x02</td>
<td>运行时可见, 但是只对系统可见，用户代码不可见</td>
</tr>
</tbody>
</table>
<p><strong>encoded_annotation 格式定义：</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Format</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>type_idx</td>
<td>uleb128</td>
<td>注解类型. 必须是类类型.</td>
</tr>
<tr>
<td>size</td>
<td>uleb128</td>
<td>注解中 name-value 键值对的个数.</td>
</tr>
<tr>
<td>elements</td>
<td>annotation_element[size]</td>
<td>注解的元素（不是偏移）. 元素需按 string_id 的索引升序排列.</td>
</tr>
</tbody>
</table>
<p><strong>annotation_element格式：</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Format</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>name_idx</td>
<td>uleb128</td>
<td>代表元素名称，是指向 stringIds 的索引 .</td>
</tr>
<tr>
<td>value</td>
<td>encoded_value</td>
<td>元素值</td>
</tr>
</tbody>
</table>
<p><strong>encoded_value格式：</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Format</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>(value_arg &lt;&lt; 5) &#124; value_type</td>
<td>ubyte</td>
<td>表示后面 value 的类型， 可选高三位 clarifying argument .下面详述. value_arg 表示 value 的长度(size - 1), 比如 0 表示 value 需要 1字节, 7 表示 value 需要8字节，不过还是有例外，下面详述.</td>
</tr>
<tr>
<td>value</td>
<td>ubyte[]</td>
<td>值，不同的类型有不同的解码方式, 通常是小端存储。</td>
</tr>
</tbody>
</table>
<p><strong>value 的格式：</strong></p>
<table>
<thead>
<tr>
<th>类型名</th>
<th>类型值</th>
<th>value_arg Format</th>
<th>value Format</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>VALUE_BYTE</td>
<td>0x00</td>
<td>必须是0</td>
<td>ubyte[1]</td>
<td>有符号1字节整形值</td>
</tr>
<tr>
<td>VALUE_SHORT</td>
<td>0x02</td>
<td>size - 1 (0…1)</td>
<td>ubyte[size]</td>
<td>有符号4字节整型值，符号扩展</td>
</tr>
<tr>
<td>VALUE_CHAR</td>
<td>0x03</td>
<td>size - 1 (0…1)</td>
<td>ubyte[size]</td>
<td>无符号4字节整型值，0扩展</td>
</tr>
<tr>
<td>VALUE_INT</td>
<td>0x04</td>
<td>size - 1 (0…3)</td>
<td>ubyte[size]</td>
<td>有符号4字节整型值，符号扩展</td>
</tr>
<tr>
<td>VALUE_LONG</td>
<td>0x06</td>
<td>size - 1 (0…7)</td>
<td>ubyte[size]</td>
<td>有符号8字节整型值，符号扩展</td>
</tr>
<tr>
<td>VALUE_FLOAT</td>
<td>0x10</td>
<td>size - 1 (0…3)</td>
<td>ubyte[size]</td>
<td>4字节位模式，0扩展为右侧，以 IEEE754 32位浮点类型解码</td>
</tr>
<tr>
<td>VALUE_DOUBLE</td>
<td>0x11</td>
<td>size - 1 (0…7)</td>
<td>ubyte[size]</td>
<td>8字节位模式，0扩展为右侧，以 IEEE754 64位浮点类型解码</td>
</tr>
<tr>
<td>VALUE_STRING</td>
<td>0x17</td>
<td>size - 1 (0…3)</td>
<td>ubyte[size]</td>
<td>无符号(0扩展)4字节整形,解码为指向string_ids的索引，代表字符串</td>
</tr>
<tr>
<td>VALUE_TYPE</td>
<td>0x18</td>
<td>size - 1 (0…3)</td>
<td>ubyte[size]</td>
<td>符号(0扩展)4字节整形,解码为指向type_ids的索引，代表类型或类</td>
</tr>
<tr>
<td>VALUE_FIELD</td>
<td>0x19</td>
<td>size - 1 (0…3)</td>
<td>ubyte[size]</td>
<td>符号(0扩展)4字节整形,解码为指向field_ids的索引，代表字段</td>
</tr>
<tr>
<td>VALUE_METHOD</td>
<td>0x1a</td>
<td>size - 1 (0…3)</td>
<td>ubyte[size]</td>
<td>符号(0扩展)4字节整形,解码为指向method_ids的索引，代表方法</td>
</tr>
<tr>
<td>VALUE_ENUM</td>
<td>0x1b</td>
<td>size - 1 (0…3)</td>
<td>ubyte[size]</td>
<td>无符号(0扩展)4字节整形,解码为指向field_ids的索引，代表枚举常量</td>
</tr>
<tr>
<td>VALUE_ARRAY</td>
<td>0x1c</td>
<td>必须是0</td>
<td>encoded_array</td>
<td>数组，格式为encoded_array format.</td>
</tr>
<tr>
<td>VALUE_ANNOTATION</td>
<td>0x1d</td>
<td>必须是0</td>
<td>encoded_annotation</td>
<td>子注解, 格式为encoded_annotation format.</td>
</tr>
<tr>
<td>VALUE_NULL</td>
<td>0x1e</td>
<td>必须是0</td>
<td>(none)</td>
<td>null</td>
</tr>
<tr>
<td>VALUE_BOOLEAN</td>
<td>0x1f</td>
<td>boolean (0…1)</td>
<td>(none)</td>
<td>一比特的值， 0 代表 false ， 1 代表 true.</td>
</tr>
</tbody>
</table>
<h4 id="field_annotations_item">field_annotations_item</h4><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> Direct-mapped <span class="string">"field_annotations_item"</span>.</span><br><span class="line"> <span class="keyword">*</span>/</span><br><span class="line">struct DexFieldAnnotationsItem &#123;</span><br><span class="line">    u4  fieldIdx;</span><br><span class="line">    u4  annotationsOff;             /<span class="keyword">*</span> 指向 DexAnnotationSetItem 的文件偏移<span class="keyword">*</span>/</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="method_annotations_item">method_annotations_item</h4><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> Direct-mapped <span class="string">"method_annotations_item"</span>.</span><br><span class="line"> <span class="keyword">*</span>/</span><br><span class="line">struct DexMethodAnnotationsItem &#123;</span><br><span class="line">    u4  methodIdx;</span><br><span class="line">    u4  annotationsOff;             /<span class="keyword">*</span> 指向 DexAnnotationSetItem 的文件偏移 <span class="keyword">*</span>/</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="parameter_annotations_item">parameter_annotations_item</h4><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> Direct-mapped <span class="string">"parameter_annotations_item"</span>.</span><br><span class="line"> <span class="keyword">*</span>/</span><br><span class="line">struct DexParameterAnnotationsItem &#123;</span><br><span class="line">    u4  methodIdx;</span><br><span class="line">    u4  annotationsOff;             /<span class="keyword">*</span> 指向 DexAnnotationSetRefList 的文件偏移<span class="keyword">*</span>/</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> Direct-mapped <span class="string">"annotation_set_ref_list"</span>.</span><br><span class="line"> <span class="keyword">*</span>/</span><br><span class="line">struct DexAnnotationSetRefList &#123;</span><br><span class="line">    u4  size;</span><br><span class="line">    DexAnnotationSetRefItem list[1];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">/<span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> Direct-mapped <span class="string">"annotation_set_ref_item"</span>.</span><br><span class="line"> <span class="keyword">*</span>/</span><br><span class="line">struct DexAnnotationSetRefItem &#123;</span><br><span class="line">    u4  annotationsOff;             /<span class="keyword">*</span> offset to DexAnnotationSetItem <span class="keyword">*</span>/</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="常量定义">常量定义</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* annotation constants */</span></span><br><span class="line"><span class="keyword">enum</span> &#123;</span><br><span class="line">    kDexVisibilityBuild         = <span class="number">0x00</span>,     <span class="comment">/* annotation visibility */</span></span><br><span class="line">    kDexVisibilityRuntime       = <span class="number">0x01</span>,</span><br><span class="line">    kDexVisibilitySystem        = <span class="number">0x02</span>,</span><br><span class="line"></span><br><span class="line">    kDexAnnotationByte          = <span class="number">0x00</span>,</span><br><span class="line">    kDexAnnotationShort         = <span class="number">0x02</span>,</span><br><span class="line">    kDexAnnotationChar          = <span class="number">0x03</span>,</span><br><span class="line">    kDexAnnotationInt           = <span class="number">0x04</span>,</span><br><span class="line">    kDexAnnotationLong          = <span class="number">0x06</span>,</span><br><span class="line">    kDexAnnotationFloat         = <span class="number">0x10</span>,</span><br><span class="line">    kDexAnnotationDouble        = <span class="number">0x11</span>,</span><br><span class="line">    kDexAnnotationString        = <span class="number">0x17</span>,</span><br><span class="line">    kDexAnnotationType          = <span class="number">0x18</span>,</span><br><span class="line">    kDexAnnotationField         = <span class="number">0x19</span>,</span><br><span class="line">    kDexAnnotationMethod        = <span class="number">0x1a</span>,</span><br><span class="line">    kDexAnnotationEnum          = <span class="number">0x1b</span>,</span><br><span class="line">    kDexAnnotationArray         = <span class="number">0x1c</span>,</span><br><span class="line">    kDexAnnotationAnnotation    = <span class="number">0x1d</span>,</span><br><span class="line">    kDexAnnotationNull          = <span class="number">0x1e</span>,</span><br><span class="line">    kDexAnnotationBoolean       = <span class="number">0x1f</span>,</span><br><span class="line"></span><br><span class="line">    kDexAnnotationValueTypeMask = <span class="number">0x1f</span>,     <span class="comment">/* low 5 bits */</span></span><br><span class="line">    kDexAnnotationValueArgShift = <span class="number">5</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="classDataOff">classDataOff</h2><p>指向 class_data_item 的文件偏移，如果此类没有数据(如接口)，值为0.<br>除了 DexCode 之外的结构是定义在 /dalvik/libdex/DexCLass.h 文件中的，并且采用的是 uleb128 编码方式。与之前不同</p>
<h3 id="class_data_item_定义">class_data_item 定义</h3><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span> expanded form of class_data_item. Note: If a particular item is</span><br><span class="line"> <span class="keyword">*</span> absent (e.g., no static fields), then the corresponding pointer</span><br><span class="line"> <span class="keyword">*</span> is set to NULL. <span class="keyword">*</span>/</span><br><span class="line">struct DexClassData &#123;</span><br><span class="line">    DexClassDataHeader header;          /<span class="keyword">*</span> 字段与方法的个数 <span class="keyword">*</span>/</span><br><span class="line">    DexField<span class="keyword">*</span>          staticFields;    /<span class="keyword">*</span> 静态字段结构 <span class="keyword">*</span>/</span><br><span class="line">    DexField<span class="keyword">*</span>          instanceFields;    /<span class="keyword">*</span> 实例字段结构 <span class="keyword">*</span>/</span><br><span class="line">    DexMethod<span class="keyword">*</span>         directMethods;    /<span class="keyword">*</span> 直接方法结构 <span class="keyword">*</span>/</span><br><span class="line">    DexMethod<span class="keyword">*</span>         virtualMethods;    /<span class="keyword">*</span> 虚方法结构 <span class="keyword">*</span>/</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">/<span class="keyword">*</span> expanded form of a class_data_item header <span class="keyword">*</span>/</span><br><span class="line">struct DexClassDataHeader &#123;</span><br><span class="line">    u4 staticFieldsSize;    /<span class="keyword">*</span>静态字段个数<span class="keyword">*</span>/</span><br><span class="line">    u4 instanceFieldsSize;  /<span class="keyword">*</span>实例字段的个数<span class="keyword">*</span>/</span><br><span class="line">    u4 directMethodsSize;   /<span class="keyword">*</span>直接方法的个数<span class="keyword">*</span>/</span><br><span class="line">    u4 virtualMethodsSize;  /<span class="keyword">*</span>虚方法的个数<span class="keyword">*</span>/</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">/<span class="keyword">*</span> expanded form of encoded_field <span class="keyword">*</span>/</span><br><span class="line">struct DexField &#123;</span><br><span class="line">    u4 fieldIdx;    /<span class="keyword">*</span>指向 DexFieldId 的索引 <span class="keyword">*</span>/</span><br><span class="line">    u4 accessFlags; /<span class="keyword">*</span> 访问标识 <span class="keyword">*</span>/</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">/<span class="keyword">*</span> expanded form of encoded_method <span class="keyword">*</span>/</span><br><span class="line">struct DexMethod &#123;</span><br><span class="line">    u4 methodIdx;    /<span class="keyword">*</span> 指向 DexMethodId 的索引 <span class="keyword">*</span>/</span><br><span class="line">    u4 accessFlags;  /<span class="keyword">*</span> 访问标识 <span class="keyword">*</span>/</span><br><span class="line">    u4 codeOff;      /<span class="keyword">*</span> 指向 DexCode 的文件偏移，如果方法是abstract或者native的，值为0<span class="keyword">*</span>/</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="code_item">code_item</h3><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> Direct-mapped <span class="string">"code_item"</span>.</span><br><span class="line"> <span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> The <span class="string">"catches"</span> table is used when throwing an exception,</span><br><span class="line"> <span class="keyword">*</span> <span class="string">"debugInfo"</span> is used when displaying an exception stack trace or</span><br><span class="line"> <span class="keyword">*</span> debugging. An offset of zero indicates that there are no entries.</span><br><span class="line"> <span class="keyword">*</span>/</span><br><span class="line">struct DexCode &#123;</span><br><span class="line">    u2  registersSize;      /<span class="keyword">*</span> 使用的寄存器个数 <span class="keyword">*</span>/</span><br><span class="line">    u2  insSize;            /<span class="keyword">*</span> 参数个数 <span class="keyword">*</span>/</span><br><span class="line">    u2  outsSize;           /<span class="keyword">*</span> 调用其他方法时使用的寄存器个数 <span class="keyword">*</span>/</span><br><span class="line">    u2  triesSize;          /<span class="keyword">*</span> Try 的个数<span class="keyword">*</span>/</span><br><span class="line">    u4  debugInfoOff;       /<span class="keyword">*</span> 调试信息(行号和局部变量信息)的文件偏移，没有的话值为0，结构为 debug_info_item<span class="keyword">*</span>/</span><br><span class="line">    u4  insnsSize;          /<span class="keyword">*</span> 指令个数，以2字节为单位<span class="keyword">*</span>/</span><br><span class="line">    u2  insns[1];           /<span class="keyword">*</span> 指令数组，指令含义参考dalvik字节码格式<span class="keyword">*</span>/</span><br><span class="line">    /<span class="keyword">*</span> 2字节用于对齐(try的结构是以4字节对齐的，只有triesSize不为0且insnsSize为奇数的时候此值才会出现) <span class="keyword">*</span>/</span><br><span class="line">    /<span class="keyword">*</span> try_item[triesSize] DexTry 结构，指示哪里有异常，怎样处理；数组中的元素必须没有重叠和覆盖 <span class="keyword">*</span>/</span><br><span class="line">    /<span class="keyword">*</span> try/catch 中 handler 的个数 <span class="keyword">*</span>/</span><br><span class="line">    /<span class="keyword">*</span> catch_handler_item[handlersSize] DexCatchHandler结构<span class="keyword">*</span>/</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="debug_info_item">debug_info_item</h4><p>每个 debug_info_item 以一个变长的 header 开始(长度取决于方法的参数个数)，接着是操作码（用来修改状态机器码的值），最后是一个结束字节 <code>DBG_END_SEQUENCE</code>。</p>
<p><strong>状态机器码</strong> 包含5个寄存器，同时也追踪着每个寄存器中最后一个局部变量的名字和类型，为 DBG_RESTART_LOCAL 做准备。<br><code>address</code>寄存器代表两字节指令的偏移地址，在每个 debug_info 序列里以0开始，单调递增；<br><code>line</code>寄存器代表下一条指令的行数，它在 header 中被初始化，可能会加减变化但绝不会小于 1；<br><code>source_file</code>寄存器代表行数所在的源文件，它的类型是 class_def_item 中的 source_file_idx；<br><code>prologue_end</code> 和 <code>epilogue_begin</code> 是布尔类型的标识(初始值为false)，代表下一条指令是不是函数入口或者函数结束。</p>
<p><strong>header 的格式：</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Format</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>line_start</td>
<td>uleb128</td>
<td>line 寄存器的初始值，不代表真实的入口</td>
</tr>
<tr>
<td>parameters_size</td>
<td>uleb128</td>
<td>参数名字的个数. 如果是实例方法的话，不包括this.</td>
</tr>
<tr>
<td>parameter_names</td>
<td>uleb128p1[parameters_size]</td>
<td>方法的参数名的字符串索引. NO_INDEX 表示相关参数没有名字. 类型描述符和签名同方法的类型描述符和签名.</td>
</tr>
</tbody>
</table>
<p><strong>debug_info 中操作的值：</strong></p>
<table>
<thead>
<tr>
<th>名字</th>
<th>值</th>
<th>格式</th>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>DBG_END_SEQUENCE</td>
<td>0x00</td>
<td></td>
<td>(none)</td>
<td>代表调试信息的终止</td>
</tr>
<tr>
<td>DBG_ADVANCE_PC</td>
<td>0x01</td>
<td>uleb128  addr_diff</td>
<td>addr_diff: 地址寄存器加上此值</td>
<td>使address寄存器指向下一个地址</td>
</tr>
<tr>
<td>DBG_ADVANCE_LINE</td>
<td>0x02</td>
<td>sleb128 line_diff</td>
<td>line_diff: line寄存器加上此值</td>
<td>使line寄存器指向新的一行</td>
</tr>
<tr>
<td>DBG_START_LOCAL</td>
<td>0x03</td>
<td>uleb128  register_num，uleb128p1 name_idx，uleb128p1 type_idx</td>
<td>register_num: 某个寄存器，name_idx: 指向string的索引，type_idx: 指向type的索引</td>
<td>在当前地址引入一个局部变量. name_idx 或 type_idx 可能是 NO_INDEX，代表此值未知.</td>
</tr>
<tr>
<td>DBG_START_LOCAL_EXTENDED</td>
<td>0x04</td>
<td>uleb128 register_num，uleb128p1 name_idx，uleb128p1 type_idx，uleb128p1 sig_idx</td>
<td>register_num: 某个寄存器，name_idx: 指向string的索引，type_idx: 指向type的索引，sig_idx: 指向string的索引，表示类型签名</td>
<td>在当前地址引入一个带有类型签名的局部变量. name_idx 或 type_idx、sig_idx 可能是 NO_INDEX，代表此值未知.”dalvik.annotation.Signature” 有关于处理签名的说明.</td>
</tr>
<tr>
<td>DBG_END_LOCAL</td>
<td>0x05</td>
<td>uleb128 register_num</td>
<td>register_num: 某个寄存器</td>
<td>代表当前地址的局部变量超出范围</td>
</tr>
<tr>
<td>DBG_RESTART_LOCAL</td>
<td>0x06</td>
<td>uleb128 register_num</td>
<td>register_num: 重新赋值的寄存器</td>
<td>在当前地址重新引入一个局部变量.名字和类型同上一个局部变量.</td>
</tr>
<tr>
<td>DBG_SET_PROLOGUE_END</td>
<td>0x07</td>
<td></td>
<td>(none)</td>
<td>设置 prologue_end 状态寄存器, 表示下一个入口点应该被视作方法开始的结束(可设置方法断点的合适地方). prologue_end寄存器的值可以被任何&gt;=0x0a的特殊操作码清空.</td>
</tr>
<tr>
<td>DBG_SET_EPILOGUE_BEGIN</td>
<td>0x08</td>
<td></td>
<td>(none)</td>
<td>设置epilogue_begin状态寄存器, 表示下一个入口点应该被视作方法结束的开始(在方法结束之前使其挂起的合适地方). epilogue_begin寄存器的值可以被任何&gt;=0x0a的特殊操作码清空.</td>
</tr>
<tr>
<td>DBG_SET_FILE</td>
<td>0x09</td>
<td>uleb128p1 name_idx</td>
<td>name_idx: 指向string的索引，表示源文件名; NO_INDEX 表示未知</td>
<td>表面接下来的行号入口都与这个文件相关, 而不是 code_item 指定的默认名字.</td>
</tr>
<tr>
<td>Special Opcodes</td>
<td>0x0a…0xff</td>
<td></td>
<td>(none)</td>
<td>line、address寄存器加减, 开启新的入口点, 清空 prologue_end、 epilogue_begin寄存器. 公式如下.</td>
</tr>
</tbody>
</table>
<p><strong>Special Opcodes：</strong></p>
<p>使 line、address 寄存器小幅度变化/开启一个新的入口点. 范围是 0x0a ~ 0xff .</p>
<p>DBG_FIRST_SPECIAL = 0x0a  // 最小的特殊操作码<br>DBG_LINE_BASE   = -4      // 最小的行号增量<br>DBG_LINE_RANGE  = 15      // 代表行号的变化值</p>
<p>公式：<br>adjusted_opcode = opcode - DBG_FIRST_SPECIAL<br>line += DBG_LINE_BASE + (adjusted_opcode % DBG_LINE_RANGE)<br>address += (adjusted_opcode / DBG_LINE_RANGE)</p>
<h4 id="try_item">try_item</h4><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> Direct-mapped <span class="string">"try_item"</span>.</span><br><span class="line"> <span class="keyword">*</span>/</span><br><span class="line">struct DexTry &#123;</span><br><span class="line">    u4  startAddr;          /<span class="keyword">*</span> 异常起始地址, 2个字节为单位 <span class="keyword">*</span>/</span><br><span class="line">    u2  insnCount;          /<span class="keyword">*</span> 指令个数, 2个字节为单位，最后一个指令为 startAddr + insnCount - 1 <span class="keyword">*</span>/</span><br><span class="line">    u2  handlerOff;         /<span class="keyword">*</span> 以 handler 列表为起始的 指向异常对应的 handler 的偏移<span class="keyword">*</span>/</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="catch_handler_item">catch_handler_item</h4><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> Catch handler entry, used while iterating over catch_handler_items.</span><br><span class="line"> <span class="keyword">*</span>/</span><br><span class="line">struct DexCatchHandler &#123;</span><br><span class="line">    u4          typeIdx;    /<span class="keyword">*</span> catch 到的异常的类型索引，指向 typeIds <span class="keyword">*</span>/</span><br><span class="line">    u4          address;    /<span class="keyword">*</span> handler 的地址 <span class="keyword">*</span>/</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="番外_-_关于_catch_handler_list">番外 - 关于 catch_handler_list</h4><p>catch_handler_list 在源码中没有定义，下面的表格是其格式：</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Format</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>size</td>
<td>uleb128</td>
<td>handler 列表的个数</td>
</tr>
<tr>
<td>list</td>
<td>encoded_catch_handler[handlers_size]</td>
<td>handler 列表</td>
</tr>
</tbody>
</table>
<p>单个 catch_handler 的格式：</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Format</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>size</td>
<td>sleb128</td>
<td>列表中 catch 到的类型的个数. 如果不是正数，则handler列表中含有可以捕获到所有异常的handler. 比如 0 表示没有指定异常的类型，只有一个所有异常handler. 2 表示有两个指定类型的异常. -1 有一个指定类型的异常和一个可以捕获到所有异常的handler.</td>
</tr>
<tr>
<td>handlers</td>
<td>DexCatchHandler[abs(size)]</td>
<td>abs(size) 个handler, 存放的是指定类型的异常.</td>
</tr>
<tr>
<td>catch_all_addr</td>
<td>uleb128 (optional)</td>
<td>可以处理所有异常的 handler 的地址. size为0或者负数时此值有效.</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="staticValuesOff">staticValuesOff</h2><p>指向 DexEncodedArray 的文件偏移，表示静态字段的初始值，值为0表示没有设定静态字段的初始值，静态字段被初始化为0或者null.</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> Direct-mapped <span class="string">"encoded_array"</span>.</span><br><span class="line"> <span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> NOTE: this structure is byte-aligned.</span><br><span class="line"> <span class="keyword">*</span>/</span><br><span class="line">struct DexEncodedArray &#123;</span><br><span class="line">    u1  array[1];                   /<span class="keyword">*</span> encoded_array 格式的数据 <span class="keyword">*</span>/</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>encoded_array 格式：</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Format</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>size</td>
<td>uleb128</td>
<td>数组元素的个数，必须不大于静态字段的个数和对应的field_list的个数，如果是小于，剩余的静态字段按照相应的类型被初始化为0或者null.</td>
</tr>
<tr>
<td>values</td>
<td>encoded_value[size]</td>
<td>数组内容</td>
</tr>
</tbody>
</table>
<hr>
<h1 id="手工查找">手工查找</h1><p>classDefsSize：0x02<br>classDefsOff：0x047c</p>
<p>0x047c ~ 0x04bc</p>
<h2 id="DexClassDef数据及其解析">DexClassDef数据及其解析</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000470</span>  .. .. .. .... .. .. ..   .. .. .. .. <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |------------....|</span><br><span class="line"><span class="number">00000480</span>  <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">0</span>e <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">1f</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |................|</span><br><span class="line"><span class="number">00000490</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> c2 <span class="number">0f</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">06</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |................|</span><br><span class="line"><span class="number">000004</span>a0  <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">02</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">20</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |............ ...|</span><br><span class="line"><span class="number">000004</span>b0  <span class="number">64</span> <span class="number">0</span>a <span class="number">00</span> <span class="number">00</span> de <span class="number">0f</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure>
<p>以第一个为例：</p>
<ol>
<li><p><code>classIdx</code>=0x05，即第0x05个typeId，得类类型为 Lcom/shell/NativeApplication;</p>
</li>
<li><p><code>accessFlags</code>=0x01，查表得权限 ACC_PUBLIC</p>
</li>
<li><p><code>superclassIdx</code>=0x0e，即第0x0e个typeId，得父类类型为 Ljava/lang/Object;</p>
</li>
<li><p><code>interfacesOff</code>=0x0000，没有实现接口</p>
</li>
<li><p><code>sourceFileIdx</code>=0x1f，即第0x1f个stringId，得源文件名为 NativeApplication.java</p>
</li>
<li><p><code>annotationsOff</code>=0x0000，没有注解</p>
</li>
<li><p><code>classDataOff</code>=0x0fc2，得DexClassData偏移为0x0fc2</p>
</li>
<li><p><code>staticValuesOff</code>=0x0000，没有静态数据的初始值</p>
</li>
</ol>
<h2 id="DexClassData数据及其解析">DexClassData数据及其解析</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000f</span>c0  .. .. <span class="number">00</span> <span class="number">00</span> <span class="number">05</span> <span class="number">00</span> <span class="number">03</span> <span class="number">88</span>  <span class="number">80</span> <span class="number">04</span> <span class="number">90</span> <span class="number">18</span> <span class="number">01</span> <span class="number">81</span> <span class="number">80</span> <span class="number">04</span>  |................|</span><br><span class="line"><span class="number">00000f</span>d0  b8 <span class="number">18</span> <span class="number">01</span> <span class="number">89</span> <span class="number">02</span> <span class="number">00</span> <span class="number">01</span> <span class="number">89</span>  <span class="number">02</span> <span class="number">00</span> <span class="number">01</span> <span class="number">89</span> <span class="number">02</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |................|</span><br><span class="line"><span class="number">00000f</span>e0  <span class="number">03</span> <span class="number">04</span> <span class="number">08</span> <span class="number">81</span> <span class="number">80</span> <span class="number">04</span> d0 <span class="number">18</span>  <span class="number">03</span> <span class="number">02</span> e8 <span class="number">18</span> <span class="number">01</span> <span class="number">09</span> f4 <span class="number">19</span>  |................|</span><br></pre></td></tr></table></figure>
<p>[<strong>注意DexClassData中数字的类型为uleb128</strong>]<br>① <strong>header</strong>：<code>staticFieldsSize</code>=0x00, <code>instanceFieldsSize</code>=0x00, <code>directMethodsSize</code>=0x05, <code>virtualMethodsSize</code>=0x00, 即0个静态字段，0个实例字段，5个直接方法，0个虚方法；</p>
<p>② <strong>directMethods</strong>：(共5个，以第一个为例)</p>
<ul>
<li><code>methodIdx</code>=0x03，即第0x03个methodId，得直接方法为 void com.shell.NativeApplication.<clinit>()</clinit></li>
<li><code>accessFlags</code>=<code>88 80 04</code>，解码为0x10008，得方法访问权限为 ACC_STATIC 和 ACC_CONSTRUCTOR</li>
<li><code>codeOff</code>=<code>90 18</code>，解码为0xc10，得 DexCode 偏移为 0xc10</li>
</ul>
<h2 id="DexCode数据及其解析">DexCode数据及其解析</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000</span>c10  <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">7</span>c <span class="number">0</span>a <span class="number">00</span> <span class="number">00</span> <span class="number">0</span>b <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |........|.......|</span><br><span class="line"><span class="number">00000</span>c20  <span class="number">1</span>a <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">71</span> <span class="number">10</span> <span class="number">20</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">1</span>a <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">71</span> <span class="number">10</span>  |....q. .......q.|</span><br><span class="line"><span class="number">00000</span>c30  <span class="number">20</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">0</span>e <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">01</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  | ...............|</span><br><span class="line"><span class="number">00000</span>c40  <span class="number">83</span> <span class="number">0</span>a <span class="number">00</span> <span class="number">00</span> <span class="number">04</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">70</span> <span class="number">10</span> <span class="number">1</span>d <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">0</span>e <span class="number">00</span>  |........p.......|</span><br><span class="line"><span class="number">00000</span>c50  <span class="number">01</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">88</span> <span class="number">0</span>a <span class="number">00</span> <span class="number">00</span> <span class="number">04</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |................|</span><br><span class="line"><span class="number">00000</span>c60  <span class="number">70</span> <span class="number">10</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">0</span>e <span class="number">00</span>  <span class="number">0</span>a <span class="number">00</span> <span class="number">04</span> <span class="number">00</span> <span class="number">04</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span>  |p...............|</span><br><span class="line"><span class="number">00000</span>c70  <span class="number">8</span>d <span class="number">0</span>a <span class="number">00</span> <span class="number">00</span> <span class="number">38</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">6</span>e <span class="number">10</span> <span class="number">12</span> <span class="number">00</span> <span class="number">09</span> <span class="number">00</span> <span class="number">0</span>c <span class="number">05</span>  |...<span class="number">.8</span>...n.......|</span><br><span class="line"><span class="number">00000</span>c80  <span class="number">6</span>e <span class="number">10</span> <span class="number">11</span> <span class="number">00</span> <span class="number">05</span> <span class="number">00</span> <span class="number">0</span>a <span class="number">05</span>  <span class="number">39</span> <span class="number">05</span> <span class="number">09</span> <span class="number">00</span> <span class="number">6</span>e <span class="number">10</span> <span class="number">12</span> <span class="number">00</span>  |n......<span class="number">.9</span>...n...|</span><br></pre></td></tr></table></figure>
<ul>
<li><code>registersSize</code>=0x0001，得寄存器个数为1</li>
<li><code>insSize</code>=0x0000，得参数个数为0</li>
<li><code>outsSize</code>=0x0001，调用其他方法使用寄存器个数为1</li>
<li><code>triesSize</code>=0x0000，try的个数为0</li>
<li><code>debugInfoOff</code>=0x0a7c，debug信息偏移为0x0a7c</li>
<li><code>insnsSize</code>=0x0b，即有0xb个2字节指令，在 0x00000c20 ~ 0x00000c35 之间</li>
<li><code>insns</code>={1a 00 00 00 71 10 20 00 00 00 1a 00 01 00 71 10 20 00 00 00 0e 00}</li>
</ul>
<h3 id="debug_info数据及其解析">debug_info数据及其解析</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000</span>a70  .. .. .. .. .. .. .. ..  .. .. .. .. <span class="number">09</span> <span class="number">00</span> <span class="number">07</span> <span class="number">0</span>e  |........\.......|</span><br><span class="line"><span class="number">00000</span>a80  <span class="number">5</span>a <span class="number">56</span> <span class="number">00</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>header:</strong><br>  line_start(09)=0x09，得line寄存器的初始值为0x09；<br>  parameters_size(0x00)=0x00，得参数的名字的个数为0；</li>
<li><strong>操作码：</strong><br>  <code>0x07</code>:DBG_SET_PROLOGUE_END，方法开始；<br>  <code>0x0e</code>:0x0e-0x0a=0x04,即行号+=DBG_LINE_BASE+(0x04%DBG_LINE_RANGE),地址+=(0x04/DBG_LINE_RANGE),得行号+0,地址+0;<br>  <code>0x5a</code>:0x5a-0x0a=0x50,即行号+=DBG_LINE_BASE+(0x50%DBG_LINE_RANGE),地址+=(0x50/DBG_LINE_RANGE),得行号+1,地址+5;<br>  <code>0x56</code>:0x56-0x0a=0x4c,即行号+=DBG_LINE_BASE+(0x4c%DBG_LINE_RANGE),地址+=(0x4c/DBG_LINE_RANGE),得行号+1,地址+5;<br>  <code>0x00</code>:DBG_END_SEQUENCE，调试结束。</li>
</ul>
<h3 id="insns_中的指令数据的解析">insns 中的指令数据的解析</h3><p>在 <a href="https://source.android.com/devices/tech/dalvik/dalvik-bytecode.html" target="_blank" rel="external">Dalvik bytecode</a> 找到 OpCode 的含义及格式，在 <a href="https://source.android.com/devices/tech/dalvik/instruction-formats.html" target="_blank" rel="external">Dalvik Executable instruction formats</a> 找到该格式的表示方式。</p>
<p><strong>第1条代码：</strong></p>
<p><strong>1a</strong> ： 含义为 <code>const-string vAA, string@BBBB</code>， 格式为 <code>1a 21c</code><br><strong>21c</strong> : 格式为 <code>AA|op BBBB</code>，表示方式有三种：<br>    <figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">op</span> vAA, <span class="operator">type</span>@BBBB</span><br><span class="line"><span class="keyword">op</span> vAA, field@BBBB</span><br><span class="line"><span class="keyword">op</span> vAA, <span class="type">string</span>@BBBB</span><br></pre></td></tr></table></figure></p>
<p><code>1a</code> 的含义已经为我们指明，我们应该采用第三种。1a 后面的6个字节为 <code>00 00 00</code>，即 AA 是 00，BBBB 是 0000。<br>则可翻译为 <code>const-string v0, string@0000</code>， 找到第0x0个 StringId 对应的字符串 /data/data/com.zyh.lightingbackup/.lib/libexec.so .<br>最终解析为 <code>const-string v0, &quot;/data/data/com.zyh.lightingbackup/.lib/libexec.so&quot;</code></p>
<p><strong>第2条代码：</strong></p>
<p><strong>71</strong> ： 含义为 <code>invoke-static</code>，格式为 <code>71 35c</code><br><strong>35c</strong> ： 格式为 <code>A|G|op BBBB F|E|D|C</code> ，表示方式有7种：<br>    <figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">[A=5]</span> op &#123;vC, vD, vE, vF, vG&#125;, meth@BBBB</span><br><span class="line"><span class="comment">[A=5]</span> op &#123;vC, vD, vE, vF, vG&#125;, type@BBBB</span><br><span class="line"><span class="comment">[A=4]</span> op &#123;vC, vD, vE, vF&#125;, <span class="keyword">kind</span>@BBBB</span><br><span class="line"><span class="comment">[A=3]</span> op &#123;vC, vD, vE&#125;, <span class="keyword">kind</span>@BBBB</span><br><span class="line"><span class="comment">[A=2]</span> op &#123;vC, vD&#125;, <span class="keyword">kind</span>@BBBB</span><br><span class="line"><span class="comment">[A=1]</span> op &#123;vC&#125;, <span class="keyword">kind</span>@BBBB</span><br><span class="line"><span class="comment">[A=0]</span> op &#123;&#125;, <span class="keyword">kind</span>@BBBB</span><br></pre></td></tr></table></figure></p>
<p>71 后面的 A = 1, G = 0，所以应该采用方式 <code>[A=1] op {vC}, kind@BBBB</code>，<br>而 BBBB = 0020, F|E|D|C = 0000，可翻译为 <code>invoke-static {v0}, kind@0020</code>，找到第 0x20 个methodId 对应的函数 void java.lang.System.load(java.lang.String) .<br>最终解析为 <code>invoke-static {v0}, Ljava/lang/System;-&gt;load(Ljava/lang/String;)V</code></p>
<p>最后我们可以使用 apktool 将 apk 文件反编译，在 /smali/com/shell/NativeApplication.smali 文件中找到 <clinit> 方法，看代码对照！</clinit></p>
<hr>
<h1 id="写程序解析">写程序解析</h1><p>稍后补上。</p>
<hr>
<h1 id="Reference">Reference</h1><p><a href="https://source.android.com/devices/tech/dalvik/dex-format.html" target="_blank" rel="external">Dalvik Executable format</a></p>
<p><a href="http://www.ituring.com.cn/book/1131" target="_blank" rel="external">《Android 软件安全与逆向分析》</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<p><img src="http://7xo976.com1.z0.glb.clouddn.com/images/github-io/Android/dex-file-general-structure-3.png" alt="part-class-defs"></p>]]>
    
    </summary>
    
      <category term="Android 安全" scheme="http://kiya-z.github.io/tags/Android-%E5%AE%89%E5%85%A8/"/>
    
      <category term="dex" scheme="http://kiya-z.github.io/tags/dex/"/>
    
      <category term="Android" scheme="http://kiya-z.github.io/categories/Android/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[解析 dex 文件结构 - 索引区和数据区（二） - Protos & Fields & Methods]]></title>
    <link href="http://kiya-z.github.io/2015/11/20/parse-dex-file-part-protos-fields-methods/"/>
    <id>http://kiya-z.github.io/2015/11/20/parse-dex-file-part-protos-fields-methods/</id>
    <published>2015-11-20T10:13:54.000Z</published>
    <updated>2015-11-22T11:46:02.279Z</updated>
    <content type="html"><![CDATA[<p><img src="http://7xo976.com1.z0.glb.clouddn.com/images/github-io/Android/dex-file-general-structure-2.png" alt="part-2"></p>
<a id="more"></a>
<h1 id="ProtoIds">ProtoIds</h1><p>ProtoIds 存放的是<strong>原型的声明</strong>，包括原型简名、参数和返回值。<br>ProtoIds 的大小和文件偏移在 DexHeader 和 map_list 中都有指定。</p>
<h2 id="结构">结构</h2><p>ProtoIds 以4字节对齐，即总大小为 4 * 3 * protoIdsSize .</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> Direct-mapped <span class="string">"proto_id_item"</span>.</span><br><span class="line"> <span class="keyword">*</span>/</span><br><span class="line">struct DexProtoId &#123;</span><br><span class="line">    u4  shortyIdx;          /<span class="keyword">*</span> 指向 stringIds 的索引，表示简名 <span class="keyword">*</span>/</span><br><span class="line">    u4  returnTypeIdx;      /<span class="keyword">*</span> 指向 TypeIds 的索引，表示返回类型 <span class="keyword">*</span>/</span><br><span class="line">    u4  parametersOff;      /<span class="keyword">*</span> 指向 type_list 的文件偏移，表示参数列表，为 0 表示没有参数，参数类型中没有空<span class="keyword">*</span>/</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> Direct-mapped <span class="string">"type_list"</span>.</span><br><span class="line"> <span class="keyword">*</span>/</span><br><span class="line">struct DexTypeList &#123;</span><br><span class="line">    u4  size;               /<span class="keyword">*</span> DexTypeItem 的个数 <span class="keyword">*</span>/</span><br><span class="line">    DexTypeItem list[1];    /<span class="keyword">*</span> DexTypeItem 数组内容 <span class="keyword">*</span>/</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> Direct-mapped <span class="string">"type_item"</span>.</span><br><span class="line"> <span class="keyword">*</span>/</span><br><span class="line">struct DexTypeItem &#123;</span><br><span class="line">    u2  typeIdx;            /<span class="keyword">*</span> 指向 typeIds 的索引<span class="keyword">*</span>/</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="手工查找">手工查找</h2><p><strong>某 dex 文件的 ProtoIds 部分</strong>：</p>
<p>protoIdsSize : 0x12<br>protoIdsOff : 0x0244</p>
<p>0x0244 ~ 0x031c</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000240</span>  <span class="built_in">.. </span><span class="built_in">.. </span><span class="built_in">.. </span><span class="built_in">.. </span><span class="number">06</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">40</span> <span class="number">0</span>a <span class="number">00</span> <span class="number">00</span>  |)<span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="built_in">..</span>@<span class="attribute">...</span>|</span><br><span class="line"><span class="number">00000250</span>  <span class="number">07</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">08</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |<span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="built_in">.</span>|</span><br><span class="line"><span class="number">00000260</span>  <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">48</span> <span class="number">0</span>a <span class="number">00</span> <span class="number">00</span>  <span class="number">09</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">08</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |<span class="attribute">...</span><span class="built_in">.</span>H<span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="built_in">..</span>|</span><br><span class="line"><span class="number">00000270</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">0</span>a <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">0</span>c <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> f8 <span class="number">09</span> <span class="number">00</span> <span class="number">00</span>  |<span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="built_in">.</span>|</span><br><span class="line"><span class="number">00000280</span>  <span class="number">09</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">0</span>f <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">0</span>a <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |<span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="built_in">.</span>|</span><br><span class="line"><span class="number">00000290</span>  <span class="number">14</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">14</span> <span class="number">0</span>a <span class="number">00</span> <span class="number">00</span>  <span class="built_in">.. </span><span class="built_in">.. </span><span class="built_in">.. </span><span class="built_in">.. </span><span class="built_in">.. </span><span class="built_in">.. </span><span class="built_in">.. </span><span class="built_in">..  </span><br><span class="line"></span><span class="attribute">...</span><span class="attribute">...</span><span class="built_in">..  </span><span class="built_in">.. </span><span class="built_in">.. </span><span class="built_in">.. </span><span class="built_in">.. </span><span class="built_in">.. </span><span class="built_in">.. </span><span class="built_in">.. </span><span class="built_in">..  </span><span class="number">28</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">17</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |<span class="attribute">...</span><span class="attribute">...</span><span class="built_in">..</span>(<span class="attribute">...</span><span class="attribute">...</span><span class="built_in">.</span>|</span><br><span class="line"><span class="number">00000300</span>  <span class="number">2</span>c <span class="number">0</span>a <span class="number">00</span> <span class="number">00</span> <span class="number">27</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">17</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">1</span>c <span class="number">0</span>a <span class="number">00</span> <span class="number">00</span>  |,<span class="attribute">...</span><span class="string">'...........|</span><br><span class="line">00000310  .. .. .. .. .. .. .. ..  14 0a 00 00</span></span><br></pre></td></tr></table></figure>
<p>以第一个 DexProtoId 为例，<br>shortyIdx=0x06 =&gt; stringIdOff=0x88 =&gt; stringDataOff=0x0544 =&gt; IL<br>returnTypeIdx=0x00 =&gt; stringId=0x05 =&gt; StringIdOff=0x84 =&gt; stringDataOff=0x0541 =&gt; I<br>parametersOff=0x0a40 =&gt; <code>01 00 00 00 18 00</code> =&gt; typeIdOff=0x240 =&gt; stringIdOff=0x29 =&gt; stringDataOff=0x079c =&gt; [B<br>即此函数声明为 int (Byte[])</p>
<p><strong>以此类推：</strong></p>
<table>
<thead>
<tr>
<th>序数</th>
<th>原型</th>
<th>返回值</th>
<th>参数</th>
<th>方法</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x00</td>
<td>IL</td>
<td>I</td>
<td>[B</td>
<td>int (Byte[])</td>
</tr>
<tr>
<td>0x01</td>
<td>J</td>
<td>J</td>
<td>无</td>
<td>long ()</td>
</tr>
<tr>
<td>0x02</td>
<td>JL</td>
<td>J</td>
<td>Ljava/io/File;</td>
<td>long (File)</td>
</tr>
<tr>
<td>0x03</td>
<td>L</td>
<td>Ljava/io/File;</td>
<td>无</td>
<td>File ()</td>
</tr>
<tr>
<td>0x04</td>
<td>LL</td>
<td>Ljava/io/InputStream;</td>
<td>Ljava/util/zip/ZipEntry;</td>
<td>InputStream (ZipENtry)</td>
</tr>
<tr>
<td>0x05</td>
<td>L</td>
<td>Ljava/lang/String;</td>
<td>无</td>
<td>String ()</td>
</tr>
<tr>
<td>0x06</td>
<td>LL</td>
<td>Ljava/util/zip/ZipEntry;</td>
<td>Ljava/lang/String;</td>
<td>ZipEntry (String)</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
<tr>
<td>0x10</td>
<td>ZLL</td>
<td>Z</td>
<td>Landroid/app/Application; Ljava/lang/String;</td>
<td>bool (Application,String)</td>
</tr>
<tr>
<td>0x11</td>
<td>ZL</td>
<td>Z</td>
<td>Ljava/lang/Object;</td>
<td>bool (Object)</td>
</tr>
<tr>
<td>0x12</td>
<td>ZL</td>
<td>Z</td>
<td>Ljava/lang/String;</td>
<td>bool (String)</td>
</tr>
</tbody>
</table>
<h2 id="写程序解析">写程序解析</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parseProtos</span><span class="params">(f)</span>:</span></span><br><span class="line">    <span class="string">'''</span><br><span class="line">    此函数基于 parseStrings 和 parseTypes 函数的结果</span><br><span class="line">    '''</span></span><br><span class="line"></span><br><span class="line">    cur_pos = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(DexStruct.DexHeader[<span class="string">'protoIdsSize'</span>]):</span><br><span class="line">        f.seek(DexStruct.DexHeader[<span class="string">'protoIdsOff'</span>] + cur_pos)</span><br><span class="line"></span><br><span class="line">        proto_shortyId = struct.unpack(<span class="string">'I'</span>,f.read(<span class="number">4</span>))[<span class="number">0</span>]</span><br><span class="line">        proto_returnTypeId = struct.unpack(<span class="string">'I'</span>,f.read(<span class="number">4</span>))[<span class="number">0</span>]</span><br><span class="line">        proto_paramtersOff = struct.unpack(<span class="string">'I'</span>,f.read(<span class="number">4</span>))[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        parameters = []</span><br><span class="line">        <span class="keyword">if</span> proto_paramtersOff &gt; <span class="number">0</span>:  <span class="comment"># 有参数再读取</span></span><br><span class="line">            f.seek(proto_paramtersOff)</span><br><span class="line">            param_size = struct.unpack(<span class="string">'I'</span>,f.read(<span class="number">4</span>))[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> range(param_size):</span><br><span class="line">                param_typeId = struct.unpack(<span class="string">'H'</span>,f.read(<span class="number">2</span>))[<span class="number">0</span>]</span><br><span class="line">                parameters.append(DexStruct.DexTypes[param_typeId][<span class="string">'content'</span>])</span><br><span class="line"></span><br><span class="line">        tmpDexProto = &#123;</span><br><span class="line">            <span class="string">'shortyDescription'</span> : DexStruct.DexStrings[proto_shortyId][<span class="string">'content'</span>],</span><br><span class="line">            <span class="string">'returnType'</span> : DexStruct.DexTypes[proto_returnTypeId][<span class="string">'content'</span>],</span><br><span class="line">            <span class="string">'parameters'</span> :  parameters,</span><br><span class="line">        &#125;;</span><br><span class="line">        DexStruct.DexProtos.append(tmpDexProto)</span><br><span class="line"></span><br><span class="line">        cur_pos += <span class="number">12</span></span><br></pre></td></tr></table></figure>
<hr>
<h1 id="FieldIds">FieldIds</h1><p>fields 表示的是类中的字段，包括本字段所属的类、字段类型和字段名。<br>FieldIds 的大小和文件偏移在 DexHeader 和 map_list 中都有指定。</p>
<h2 id="结构-1">结构</h2><p>以 4 字节对齐。</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> Direct-mapped <span class="string">"field_id_item"</span>.</span><br><span class="line"> <span class="keyword">*</span>/</span><br><span class="line">struct DexFieldId &#123;</span><br><span class="line">    u2  classIdx;           /<span class="keyword">*</span> 指向 typeIds 的索引，表示定义这个字段的类 <span class="keyword">*</span>/</span><br><span class="line">    u2  typeIdx;            /<span class="keyword">*</span> 指向 typeIds 的索引，表示字段类型 <span class="keyword">*</span>/</span><br><span class="line">    u4  nameIdx;            /<span class="keyword">*</span> 指向 stringIds 的索引，表示字段名<span class="keyword">*</span>/</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="手动查找">手动查找</h2><p><strong>某 dex 文件的 FieldIds 部分</strong>：</p>
<p>fieldIdsSize : 0x01<br>fieldIdsOff : 0x031c</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">00000310  .. .. .. .. .. .. .. ..  .. .. .. .. 04 00 0f 00  |<span class="string">'...............</span>|</span><br><span class="line">00000320  04 00 00 00 .. .. .. ..  .. .. .. .. .. .. .. ..  |<span class="string">................</span>|</span><br></pre></td></tr></table></figure>
<p>由 DexFieldId 可得 ：<br>classIdx=0x0004 =&gt; typeId=0x0d =&gt; stringDataOff=0x00a4 =&gt; Landroid/os/Build;<br>typeIdx=0x000f =&gt; typeId=0x18 =&gt; stringDataOff=0x00d0 =&gt; Ljava/lang/String;<br>nameIdx=0x00000004 =&gt; stringDataOff=0x0538 =&gt; CPU_ABI</p>
<h2 id="写程序解析-1">写程序解析</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parseFields</span><span class="params">(f)</span>:</span></span><br><span class="line">    <span class="string">'''</span><br><span class="line">    此函数基于 parseStrings 和 parseTypes 函数的结果</span><br><span class="line">    '''</span></span><br><span class="line">    f.seek(DexStruct.DexHeader[<span class="string">'fieldIdsOff'</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(DexStruct.DexHeader[<span class="string">'fieldIdsSize'</span>]):</span><br><span class="line">        field_class = DexStruct.DexTypes[struct.unpack(<span class="string">'H'</span>,f.read(<span class="number">2</span>))[<span class="number">0</span>]][<span class="string">'content'</span>]</span><br><span class="line">        field_type = DexStruct.DexTypes[struct.unpack(<span class="string">'H'</span>,f.read(<span class="number">2</span>))[<span class="number">0</span>]][<span class="string">'content'</span>]</span><br><span class="line">        field_name = DexStruct.DexStrings[struct.unpack(<span class="string">'I'</span>,f.read(<span class="number">4</span>))[<span class="number">0</span>]][<span class="string">'content'</span>]</span><br><span class="line"></span><br><span class="line">        tmpDexFieldItem = &#123;</span><br><span class="line">            <span class="string">'class'</span> : field_class,</span><br><span class="line">            <span class="string">'Type'</span> : field_type,</span><br><span class="line">            <span class="string">'name'</span> : field_name,</span><br><span class="line">        &#125;</span><br><span class="line">        DexStruct.DexFields.append(tmpDexFieldItem)</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="Methods">Methods</h1><p>MethodId 表示的是方法，包括本方法所属的类、方法原型 (proto) 和方法名。<br>MethodId 的大小和文件偏移在 DexHeader 和 map_list 中都有指定。</p>
<h2 id="结构-2">结构</h2><p>以 4 字节对齐。</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> Direct-mapped <span class="string">"method_id_item"</span>.</span><br><span class="line"> <span class="keyword">*</span>/</span><br><span class="line">struct DexMethodId &#123;</span><br><span class="line">    u2  classIdx;           /<span class="keyword">*</span> 指向 typeIds，表示定义这个方法的类 <span class="keyword">*</span>/</span><br><span class="line">    u2  protoIdx;           /<span class="keyword">*</span> 指向 protoIds，表示方法的原型<span class="keyword">*</span>/</span><br><span class="line">    u4  nameIdx;            /<span class="keyword">*</span> 指向 stringIds，表示方法名 <span class="keyword">*</span>/</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="手动查找-1">手动查找</h2><p><strong>某 dex 文件的 methodIds 部分</strong>：</p>
<p>methodIdsSize : 0x2b<br>methodIdsOff : 0x0324</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000320</span>  .. .. .. .. <span class="number">02</span> <span class="number">00</span> <span class="number">07</span> <span class="number">00</span>  <span class="number">03</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">02</span> <span class="number">00</span> <span class="number">08</span> <span class="number">00</span>  |................|</span><br><span class="line"><span class="number">00000330</span>  <span class="number">30</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> .. ...</span><br><span class="line">........</span><br><span class="line"><span class="number">00000470</span>  <span class="number">42</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">15</span> <span class="number">00</span> <span class="number">04</span> <span class="number">00</span>  <span class="number">43</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure>
<p>以第一个 <code>02 00 07 00 03 00 00 00</code> 为例：<br>classIdx=0x02 =&gt; Landroid/app/Application;<br>protoIdx=0x07 =&gt; void ()<br>nameIdx=0x03 =&gt; &lt;init&gt;<br>即该函数为 void android.app.Application.&lt;init&gt;()</p>
<p>以此类推：</p>
<table>
<thead>
<tr>
<th>序数</th>
<th>所属的类</th>
<th>函数原型</th>
<th>函数名</th>
<th>全称</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x00</td>
<td>Landroid/app/Application;</td>
<td>void ()</td>
<td><init></init></td>
<td>void android.app.Application.<init>()</init></td>
</tr>
<tr>
<td>0x01</td>
<td>Landroid/app/Application;</td>
<td>void (android.content.Context)</td>
<td>attachBaseContext</td>
<td>void android.app.Application.attachBaseContext(android.content.Context)</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
<tr>
<td>0x2b</td>
<td>Ljava/util/zip/ZipFile;</td>
<td>InputStream (ZipENtry)</td>
<td>getInputStream</td>
<td>java.io.InputStream java.util.zip.ZipFile.getInputStream(java.util.zip.ZipEntry)</td>
</tr>
</tbody>
</table>
<h2 id="写程序解析-2">写程序解析</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parseMethods</span><span class="params">(f)</span>:</span></span><br><span class="line">    <span class="string">'''</span><br><span class="line">    此函数基于 parseStrings、parseProtos 和 parseTypes 函数的结果</span><br><span class="line">    '''</span></span><br><span class="line"></span><br><span class="line">    f.seek(DexStruct.DexHeader[<span class="string">'methodIdsOff'</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(DexStruct.DexHeader[<span class="string">'methodIdsSize'</span>]):</span><br><span class="line">        method_class = DexStruct.DexTypes[struct.unpack(<span class="string">'H'</span>,f.read(<span class="number">2</span>))[<span class="number">0</span>]][<span class="string">'content'</span>]</span><br><span class="line">        method_proto = DexStruct.DexProtos[struct.unpack(<span class="string">'H'</span>,f.read(<span class="number">2</span>))[<span class="number">0</span>]]</span><br><span class="line">        method_name = DexStruct.DexStrings[struct.unpack(<span class="string">'I'</span>,f.read(<span class="number">4</span>))[<span class="number">0</span>]][<span class="string">'content'</span>]</span><br><span class="line"></span><br><span class="line">        tmpDexMethodItem = &#123;</span><br><span class="line">            <span class="string">'class'</span> : method_class,</span><br><span class="line">            <span class="string">'proto'</span> : method_proto,</span><br><span class="line">            <span class="string">'name'</span> : method_name,</span><br><span class="line">        &#125;</span><br><span class="line">        DexStruct.DexMethods.append(tmpDexMethodItem)</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="Reference">Reference</h1><p><a href="https://source.android.com/devices/tech/dalvik/dex-format.html" target="_blank" rel="external">Dalvik Executable format</a></p>
<p><a href="http://www.ituring.com.cn/book/1131" target="_blank" rel="external">《Android 软件安全与逆向分析》</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<p><img src="http://7xo976.com1.z0.glb.clouddn.com/images/github-io/Android/dex-file-general-structure-2.png" alt="part-2"></p>]]>
    
    </summary>
    
      <category term="Android 安全" scheme="http://kiya-z.github.io/tags/Android-%E5%AE%89%E5%85%A8/"/>
    
      <category term="dex" scheme="http://kiya-z.github.io/tags/dex/"/>
    
      <category term="Android" scheme="http://kiya-z.github.io/categories/Android/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[解析 dex 文件结构 - 索引区和数据区（一） - Strings & Types]]></title>
    <link href="http://kiya-z.github.io/2015/11/19/parse-dex-file-part-strings-and-type-descriptors/"/>
    <id>http://kiya-z.github.io/2015/11/19/parse-dex-file-part-strings-and-type-descriptors/</id>
    <published>2015-11-19T14:44:52.000Z</published>
    <updated>2015-11-22T17:00:15.482Z</updated>
    <content type="html"><![CDATA[<p><img src="http://7xo976.com1.z0.glb.clouddn.com/images/github-io/Android/dex-file-general-structure-1.png" alt="part-1"></p>
<a id="more"></a>
<h1 id="前言">前言</h1><p>在 <a href="http://kiya-z.github.io/2015/11/17/parse-dex-file-part-dex-header/">解析 dex 文件结构 - DexHeader</a> 中我们知道 Table 部分就是索引结构区，他们是是作为指向 Data 区数据的结构索引而存在的。<br>数据区是 dex 会用到的全部数据。</p>
<hr>
<h1 id="StringIds_和_StringData">StringIds 和 StringData</h1><p>StringIds 存放的是字符串的 id，也就是数据区中各个 StringData 的文件偏移。<br>StringIds 的大小和文件偏移在 DexHeader 和 map_list 中都有指定。</p>
<h2 id="结构">结构</h2><p>StringIds 以4字节对齐，即总大小为 4 * stringIdsSize .</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> Direct-mapped <span class="string">"string_id_item"</span>.</span><br><span class="line"> <span class="keyword">*</span>/</span><br><span class="line">struct DexStringId &#123;</span><br><span class="line">    u4 stringDataOff;      /<span class="keyword">*</span> file offset to string_data_item <span class="keyword">*</span>/</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>按照 StringIds 指示的偏移来到数据区对应的位置，StringData 采用的格式为：</p>
<p><strong>字符串长度</strong> : uleb128 格式，不包括字符串尾部的 00 。<br><strong>字符串内容</strong>：MUTF-8(经过修改的UTF-8)，以 00 结尾 .</p>
<h2 id="手工查找">手工查找</h2><p><strong>某 dex 文件的 StringIds 部分</strong>：</p>
<p>stringIdsSize：0x5c<br>stringIdsOff：0x0070</p>
<p>0x0070 ~ 0x01df</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000070</span>  bc <span class="number">04</span> <span class="number">00</span> <span class="number">00</span> ef <span class="number">04</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">26</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">30</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span>  |........&amp;..<span class="number">.0</span>...|</span><br><span class="line"><span class="number">00000080</span>  <span class="number">38</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">41</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">44</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">48</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span>  |<span class="number">8.</span>..A...D...H...|</span><br><span class="line"><span class="number">00000090</span>  <span class="number">4</span>b <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">4f</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">52</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">56</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span>  |K...O...R...V...|</span><br><span class="line"><span class="number">000000</span>a0  <span class="number">71</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">8</span>c <span class="number">05</span> <span class="number">00</span> <span class="number">00</span>  a0 <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> bf <span class="number">05</span> <span class="number">00</span> <span class="number">00</span>  |q...............|</span><br><span class="line"><span class="number">000000</span>b0  dd <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> f9 <span class="number">05</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">09</span> <span class="number">06</span> <span class="number">00</span> <span class="number">00</span> <span class="number">24</span> <span class="number">06</span> <span class="number">00</span> <span class="number">00</span>  |............$...|</span><br><span class="line"><span class="number">000000</span>c0  <span class="number">40</span> <span class="number">06</span> <span class="number">00</span> <span class="number">00</span> <span class="number">57</span> <span class="number">06</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">6</span>e <span class="number">06</span> <span class="number">00</span> <span class="number">00</span> <span class="number">85</span> <span class="number">06</span> <span class="number">00</span> <span class="number">00</span>  |@...W...n.......|</span><br><span class="line">........  .. .. .. ..</span><br><span class="line"><span class="number">000001</span>c0  c4 <span class="number">09</span> <span class="number">00</span> <span class="number">00</span> c9 <span class="number">09</span> <span class="number">00</span> <span class="number">00</span>  d1 <span class="number">09</span> <span class="number">00</span> <span class="number">00</span> dd <span class="number">09</span> <span class="number">00</span> <span class="number">00</span>  |................|</span><br><span class="line"><span class="number">000001</span>d0  e4 <span class="number">09</span> <span class="number">00</span> <span class="number">00</span> eb <span class="number">09</span> <span class="number">00</span> <span class="number">00</span>  f0 <span class="number">09</span> <span class="number">00</span> <span class="number">00</span> f4 <span class="number">09</span> <span class="number">00</span> <span class="number">00</span>  |................|</span><br></pre></td></tr></table></figure>
<p>以第一个字符串为例，文件偏移为 <code>bc 04 00 00</code>：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">000004</span>b0  <span class="number">64</span> <span class="number">0</span>a <span class="number">00</span> <span class="number">00</span> de <span class="number">0f</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">31</span> <span class="number">2f</span> <span class="number">64</span> <span class="number">61</span>  |d..........<span class="number">.1</span>/da|</span><br><span class="line"><span class="number">000004</span>c0  <span class="number">74</span> <span class="number">61</span> <span class="number">2f</span> <span class="number">64</span> <span class="number">61</span> <span class="number">74</span> <span class="number">61</span> <span class="number">2f</span>  <span class="number">63</span> <span class="number">6f</span> <span class="number">6</span>d <span class="number">2</span>e <span class="number">7</span>a <span class="number">79</span> <span class="number">68</span> <span class="number">2</span>e  |ta/data/com.zyh.|</span><br><span class="line"><span class="number">000004</span>d0  <span class="number">6</span>c <span class="number">69</span> <span class="number">67</span> <span class="number">68</span> <span class="number">74</span> <span class="number">69</span> <span class="number">6</span>e <span class="number">67</span>  <span class="number">62</span> <span class="number">61</span> <span class="number">63</span> <span class="number">6</span>b <span class="number">75</span> <span class="number">70</span> <span class="number">2f</span> <span class="number">2</span>e  |lightingbackup/.|</span><br><span class="line"><span class="number">000004e0</span>  <span class="number">6</span>c <span class="number">69</span> <span class="number">62</span> <span class="number">2f</span> <span class="number">6</span>c <span class="number">69</span> <span class="number">62</span> <span class="number">65</span>  <span class="number">78</span> <span class="number">65</span> <span class="number">63</span> <span class="number">2</span>e <span class="number">73</span> <span class="number">6f</span> <span class="number">00</span> <span class="number">35</span>  |lib/libexec.so<span class="number">.5</span>|</span><br></pre></td></tr></table></figure></p>
<p>根据 <a href="http://kiya-z.github.io/2015/11/18/parse-dex-file-part-leb128/">LEB128 的解码格式</a>可知：<br>字符串的长度为 0x31(有效位：011 0001) = 49 个字节。(“/data/data/com.zyh.lightingbackup/.lib/libexec.so”)</p>
<p><strong>以此类推：</strong></p>
<table>
<thead>
<tr>
<th>序数</th>
<th>文件偏移</th>
<th>字符串长度</th>
<th>字符串</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x00</td>
<td>0x04bc</td>
<td>0x31</td>
<td>/data/data/com.zyh.lightingbackup/.lib/libexec.so</td>
</tr>
<tr>
<td>0x01</td>
<td>0x04ef</td>
<td>0x35</td>
<td>/data/data/com.zyh.lightingbackup/.lib/libexecmain.so</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
<tr>
<td>0x04</td>
<td>0x0538</td>
<td>0x07</td>
<td>CPU_ABI</td>
</tr>
<tr>
<td>0x05</td>
<td>0x0541</td>
<td>0x01</td>
<td>I</td>
</tr>
<tr>
<td>0x06</td>
<td>0x0544</td>
<td>0x02</td>
<td>IL</td>
</tr>
<tr>
<td>0x07</td>
<td>0x0548</td>
<td>0x01</td>
<td>J</td>
</tr>
<tr>
<td>0x08</td>
<td>0x054b</td>
<td>0x02</td>
<td>JL</td>
</tr>
<tr>
<td>0x09</td>
<td>0x054f</td>
<td>0x01</td>
<td>L</td>
</tr>
<tr>
<td>0x0a</td>
<td>0x0552</td>
<td>0x02</td>
<td>LL</td>
</tr>
<tr>
<td>0x0b</td>
<td>0x0556</td>
<td>0x19</td>
<td>Landroid/app/Application;</td>
</tr>
<tr>
<td>0x0c</td>
<td>0x0571</td>
<td>0x19</td>
<td>Landroid/content/Context;</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
<tr>
<td>0x5b</td>
<td>0x09f0</td>
<td>0x02</td>
<td>ze</td>
</tr>
<tr>
<td>0x5c</td>
<td>0x09f4</td>
<td>0x02</td>
<td>zf</td>
</tr>
</tbody>
</table>
<h2 id="写程序解析字符串">写程序解析字符串</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">readuleb128</span><span class="params">(f)</span>:</span></span><br><span class="line">    num = struct.unpack(<span class="string">'B'</span>,f.read(<span class="number">1</span>))[<span class="number">0</span>]     <span class="comment"># 读第一字节</span></span><br><span class="line">    <span class="keyword">if</span> num &gt; <span class="number">0x7f</span> :</span><br><span class="line">        cur = struct.unpack(<span class="string">'B'</span>,f.read(<span class="number">1</span>))[<span class="number">0</span>]     <span class="comment">#读第二字节</span></span><br><span class="line">        num = (num <span class="keyword">and</span> <span class="number">0x7f</span>) <span class="keyword">or</span> ((cur <span class="keyword">and</span> <span class="number">0x7f</span>) &lt;&lt; <span class="number">7</span>)</span><br><span class="line">        <span class="keyword">if</span> cur &gt; <span class="number">0x7f</span>:</span><br><span class="line">            cur = struct.unpack(<span class="string">'B'</span>,f.read(<span class="number">1</span>))[<span class="number">0</span>]     <span class="comment">#读第三字节</span></span><br><span class="line">            num = num <span class="keyword">or</span> ((cur <span class="keyword">and</span> <span class="number">0x7f</span>) &lt;&lt; <span class="number">14</span>)</span><br><span class="line">            <span class="keyword">if</span> cur &gt; <span class="number">0x7f</span>:</span><br><span class="line">                cur = struct.unpack(<span class="string">'B'</span>,f.read(<span class="number">1</span>))[<span class="number">0</span>]     <span class="comment">#读第四字节</span></span><br><span class="line">                num = num <span class="keyword">or</span> ((cur <span class="keyword">and</span> <span class="number">0x7f</span>) &lt;&lt; <span class="number">21</span>)</span><br><span class="line">                <span class="keyword">if</span> cur &gt; <span class="number">0x7f</span>:</span><br><span class="line">                    cur = struct.unpack(<span class="string">'B'</span>,f.read(<span class="number">1</span>))[<span class="number">0</span>]     <span class="comment">#读第五字节</span></span><br><span class="line">                    num = num <span class="keyword">or</span> ((cur <span class="keyword">and</span> <span class="number">0x7f</span>) &lt;&lt; <span class="number">28</span>)</span><br><span class="line">    <span class="keyword">return</span> num</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parseStrings</span><span class="params">(f)</span>:</span></span><br><span class="line"></span><br><span class="line">    f.seek(DexStruct.DexHeader[<span class="string">'stringIdsOff'</span>])</span><br><span class="line">    stringIds_data = f.read(<span class="number">4</span>*DexStruct.DexHeader[<span class="string">'stringIdsSize'</span>])</span><br><span class="line"></span><br><span class="line">    cur_pos = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(DexStruct.DexHeader[<span class="string">'stringIdsSize'</span>]):</span><br><span class="line">        str_off =  struct.unpack(<span class="string">'I'</span>,stringIds_data[cur_pos:cur_pos+<span class="number">4</span>])[<span class="number">0</span>]</span><br><span class="line">        f.seek(str_off)</span><br><span class="line">        str_len = readuleb128(f)</span><br><span class="line">        str_content = f.read(str_len)</span><br><span class="line">        cur_pos += <span class="number">4</span></span><br><span class="line">        tmpDexStringItem = &#123;</span><br><span class="line">            <span class="string">'offset'</span> : str_off,</span><br><span class="line">            <span class="string">'len'</span> : str_len,</span><br><span class="line">            <span class="string">'content'</span> : str_content,</span><br><span class="line">        &#125;</span><br><span class="line">        DexStruct.DexStrings.append(tmpDexStringItem)</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="TypeIds">TypeIds</h1><p>TypeIds 存放的是 stringIds 内的索引，也就是说 StringData 里面的一些字符串是类型描述符。<br>TypeIds 的大小和文件偏移在 DexHeader 和 map_list 中都有指定。</p>
<p>这里的类型描述符可以代表 dex 文件中的任何类型，包括基本类型，类类型，数组类型和空类型。</p>
<h2 id="结构-1">结构</h2><p>TypeIds 以4字节对齐，即总大小为 4 * typeIdsSize .</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> Direct-mapped <span class="string">"type_id_item"</span>.</span><br><span class="line"> <span class="keyword">*</span>/</span><br><span class="line">struct DexTypeId &#123;</span><br><span class="line">    u4  descriptorIdx;      /<span class="keyword">*</span> index into stringIds list for type descriptor <span class="keyword">*</span>/</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>通过 <code>descriptorIdx</code> 可以得到相应<code>类型描述符</code>的字符串的 StringId，从而找到相应的字符串。</p>
<h2 id="手动查找">手动查找</h2><p><strong>某 dex 文件的 TypeIds 部分</strong>：</p>
<p>TypeIdsSize：0x19<br>TypeIdsOff：0x01e0</p>
<p>0x01e0 ~ 0x0244</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">000001e0</span>  <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">07</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">0</span>b <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">0</span>c <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |................|</span><br><span class="line"><span class="number">000001f</span>0  <span class="number">0</span>d <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">0</span>e <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">0f</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">10</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |................|</span><br><span class="line"><span class="number">00000200</span>  <span class="number">11</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">12</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">13</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">14</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |................|</span><br><span class="line"><span class="number">00000210</span>  <span class="number">15</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">16</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">17</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">18</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |................|</span><br><span class="line"><span class="number">00000220</span>  <span class="number">19</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">1</span>a <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">1</span>b <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">1</span>c <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |................|</span><br><span class="line"><span class="number">00000230</span>  <span class="number">1</span>d <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">1</span>e <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">21</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">26</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |........!...&amp;...|</span><br><span class="line"><span class="number">00000240</span>  <span class="number">29</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure>
<p>以第一个索引值 0x05 为例，在 StringIds 中找到第 0x05 个 StringId，也就是 0x0070(stringIdsOff) + 0x05 * 4 = 0x0084，<br>该地址值为 0x0541，0x0541 处的字符串为 “I”，int 类型。类型对照参见下表 - Dalvik 字节码类型。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>V</td>
<td>void; 只用于返回值</td>
</tr>
<tr>
<td>Z</td>
<td>boolean</td>
</tr>
<tr>
<td>B</td>
<td>byte</td>
</tr>
<tr>
<td>S</td>
<td>short</td>
</tr>
<tr>
<td>C</td>
<td>char</td>
</tr>
<tr>
<td>I</td>
<td>int</td>
</tr>
<tr>
<td>J</td>
<td>long</td>
</tr>
<tr>
<td>F</td>
<td>float</td>
</tr>
<tr>
<td>D</td>
<td>double</td>
</tr>
<tr>
<td>Lfully/qualified/Name;</td>
<td>类名：fully.qualified.Name</td>
</tr>
<tr>
<td>[descriptor</td>
<td>数组描述符，可以表示多维数组如 [[[descriptor，但最多只能有255个维度</td>
</tr>
</tbody>
</table>
<p>以此类推：</p>
<table>
<thead>
<tr>
<th>序数</th>
<th>descriptorIdx</th>
<th>StringId</th>
<th>Type</th>
<th>真正类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x00</td>
<td>0x05</td>
<td>0x0084</td>
<td>I</td>
<td>int</td>
</tr>
<tr>
<td>0x01</td>
<td>0x07</td>
<td>0x008c</td>
<td>J</td>
<td>long</td>
</tr>
<tr>
<td>0x02</td>
<td>0x0b</td>
<td>0x009c</td>
<td>Landroid/app/Application;</td>
<td>android.app.Application</td>
</tr>
<tr>
<td>0x03</td>
<td>0x0c</td>
<td>0x00a0</td>
<td>Landroid/content/Context;</td>
<td>android.content.Context</td>
</tr>
<tr>
<td>0x04</td>
<td>0x0d</td>
<td>0x00a4</td>
<td>Landroid/os/Build;</td>
<td>android.os.Build</td>
</tr>
<tr>
<td>0x05</td>
<td>0x0e</td>
<td>0x00a8</td>
<td>Lcom/shell/NativeApplication;</td>
<td>com.shell.NativeApplication</td>
</tr>
<tr>
<td>0x06</td>
<td>0x0f</td>
<td>0x00ac</td>
<td>Lcom/shell/SuperApplication;</td>
<td>com.shell.SuperApplication</td>
</tr>
<tr>
<td>0x07</td>
<td>0x10</td>
<td>0x00b0</td>
<td>Ldalvik/annotation/Throws;</td>
<td>dalvik.annotation.Throws</td>
</tr>
<tr>
<td>0x08</td>
<td>0x11</td>
<td>0x00b4</td>
<td>Ljava/io/File;</td>
<td>java.io.File</td>
</tr>
<tr>
<td>0x09</td>
<td>0x12</td>
<td>0x00b8</td>
<td>Ljava/io/FileInputStream;</td>
<td>java.io.FileInputStream</td>
</tr>
<tr>
<td>0x0a</td>
<td>0x13</td>
<td>0x00bc</td>
<td>Ljava/io/FileOutputStream;</td>
<td>java.io.FileOutputStream</td>
</tr>
<tr>
<td>0x0b</td>
<td>0x14</td>
<td>0x00c0</td>
<td>Ljava/io/IOException;</td>
<td>java.io.IOException</td>
</tr>
<tr>
<td>0x0c</td>
<td>0x15</td>
<td>0x00c4</td>
<td>Ljava/io/InputStream;</td>
<td>java.io.InputStream</td>
</tr>
<tr>
<td>0x0d</td>
<td>0x16</td>
<td>0x00c8</td>
<td>Ljava/lang/Exception;</td>
<td>java.lang.Exception</td>
</tr>
<tr>
<td>0x0e</td>
<td>0x17</td>
<td>0x00cc</td>
<td>Ljava/lang/Object;</td>
<td>java.lang.Object</td>
</tr>
<tr>
<td>0x0f</td>
<td>0x18</td>
<td>0x00d0</td>
<td>Ljava/lang/String;</td>
<td>java.lang.String</td>
</tr>
<tr>
<td>0x10</td>
<td>0x19</td>
<td>0x00d4</td>
<td>Ljava/lang/System;</td>
<td>java.lang.System</td>
</tr>
<tr>
<td>0x11</td>
<td>0x1a</td>
<td>0x00d8</td>
<td>Ljava/util/zip/CRC32;</td>
<td>java.util.zip.CRC32</td>
</tr>
<tr>
<td>0x12</td>
<td>0x1b</td>
<td>0x00dc</td>
<td>Ljava/util/zip/CheckedInputStream;</td>
<td>java.util.zip.CheckedInputStream</td>
</tr>
<tr>
<td>0x13</td>
<td>0x1c</td>
<td>0x00e0</td>
<td>Ljava/util/zip/Checksum;</td>
<td>java.util.zip.Checksum</td>
</tr>
<tr>
<td>0x14</td>
<td>0x1d</td>
<td>0x00e4</td>
<td>Ljava/util/zip/ZipEntry;</td>
<td>java.util.zip.ZipEntry</td>
</tr>
<tr>
<td>0x15</td>
<td>0x1e</td>
<td>0x00e8</td>
<td>Ljava/util/zip/ZipFile;</td>
<td>java.util.zip.ZipFile</td>
</tr>
<tr>
<td>0x16</td>
<td>0x21</td>
<td>0x00f4</td>
<td>V</td>
<td>void</td>
</tr>
<tr>
<td>0x17</td>
<td>0x26</td>
<td>0x0108</td>
<td>Z</td>
<td>boolean</td>
</tr>
<tr>
<td>0x18</td>
<td>0x29</td>
<td>0x0114</td>
<td>[B]</td>
<td>byte[]</td>
</tr>
</tbody>
</table>
<h2 id="写程序解析_TypeIds">写程序解析 TypeIds</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parseTypes</span><span class="params">(f)</span>:</span></span><br><span class="line">    <span class="string">'''</span><br><span class="line">    此函数基于 parseStrings 函数的结果，调用前需先调用 parseStrings</span><br><span class="line">    '''</span></span><br><span class="line">    f.seek(DexStruct.DexHeader[<span class="string">'typeIdsOff'</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(DexStruct.DexHeader[<span class="string">'typeIdsSize'</span>]):</span><br><span class="line">        type_desc_id = struct.unpack(<span class="string">'I'</span>,f.read(<span class="number">4</span>))[<span class="number">0</span>]</span><br><span class="line">        DexStruct.DexTypes.append(DexStruct.DexStrings[type_desc_id])</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="Reference">Reference</h1><p><a href="https://source.android.com/devices/tech/dalvik/dex-format.html" target="_blank" rel="external">Dalvik Executable format</a></p>
<p><a href="http://www.ituring.com.cn/book/1131" target="_blank" rel="external">《Android 软件安全与逆向分析》</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<p><img src="http://7xo976.com1.z0.glb.clouddn.com/images/github-io/Android/dex-file-general-structure-1.png" alt="part-1"></p>]]>
    
    </summary>
    
      <category term="Android 安全" scheme="http://kiya-z.github.io/tags/Android-%E5%AE%89%E5%85%A8/"/>
    
      <category term="dex" scheme="http://kiya-z.github.io/tags/dex/"/>
    
      <category term="Android" scheme="http://kiya-z.github.io/categories/Android/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[号称 Edit Everything 的 010 Editor]]></title>
    <link href="http://kiya-z.github.io/2015/11/19/tools-010-editor/"/>
    <id>http://kiya-z.github.io/2015/11/19/tools-010-editor/</id>
    <published>2015-11-18T17:22:42.000Z</published>
    <updated>2015-11-19T06:13:37.390Z</updated>
    <content type="html"><![CDATA[<h2 id="介绍">介绍</h2><p>010 Editor 是一款 16 进制编辑器，Text Editor 、HexEditor 、Disk Editor &amp; Process Editor .</p>
<a id="more"></a>
<p>支持文件的二进制比较；</p>
<p>支持 bmp 、avi 、map3 、map4 等常见文件和 AndroidManifest、dex 、elf 、exe等程序员文件的解析，学习文件格式解析的时候再也不用怕点来点去找不到字节了～<br>这些解析脚本都是由很多人提交的，如果你认为现有的脚本有何不足或者你解析了一种新的文件格式，都可以向网站提交，然后出现在下载页面！</p>
<p>30 天试用期。</p>
<h2 id="链接">链接</h2><p><a href="http://www.sweetscape.com/010editor/" target="_blank" rel="external">官网</a></p>
<p><a href="http://www.sweetscape.com/010editor/templates/" target="_blank" rel="external">脚本下载</a></p>
<p><a href="http://www.sweetscape.com/010editor/features.html" target="_blank" rel="external">全部特性</a></p>
<p><a href="http://www.sweetscape.com/010editor/screenshots.html" target="_blank" rel="external">在线引导</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<h2 id="介绍">介绍</h2><p>010 Editor 是一款 16 进制编辑器，Text Editor 、HexEditor 、Disk Editor &amp; Process Editor .</p>]]>
    
    </summary>
    
      <category term="工具" scheme="http://kiya-z.github.io/tags/%E5%B7%A5%E5%85%B7/"/>
    
      <category term="神器" scheme="http://kiya-z.github.io/tags/%E7%A5%9E%E5%99%A8/"/>
    
      <category term="Cool" scheme="http://kiya-z.github.io/categories/Cool/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[解析 dex 文件结构 - LEB128]]></title>
    <link href="http://kiya-z.github.io/2015/11/18/parse-dex-file-part-leb128/"/>
    <id>http://kiya-z.github.io/2015/11/18/parse-dex-file-part-leb128/</id>
    <published>2015-11-18T10:10:39.000Z</published>
    <updated>2015-11-19T12:03:53.995Z</updated>
    <content type="html"><![CDATA[<h2 id="引言">引言</h2><p>dex 文件中用到的数据类型有:</p>
<a id="more"></a>
<table>
<thead>
<tr>
<th>类型</th>
<th>编码格式</th>
</tr>
</thead>
<tbody>
<tr>
<td>byte</td>
<td>8位有符号整数</td>
</tr>
<tr>
<td>ubyte</td>
<td>8位无符号整数</td>
</tr>
<tr>
<td>short</td>
<td>16位有符号整数，小端存储</td>
</tr>
<tr>
<td>ushort</td>
<td>16位无符号整数，小端存储</td>
</tr>
<tr>
<td>int</td>
<td>32位有符号整数，小端存储</td>
</tr>
<tr>
<td>uint</td>
<td>32位无符号整数，小端存储</td>
</tr>
<tr>
<td>long</td>
<td>64位有符号整数，小端存储</td>
</tr>
<tr>
<td>ulong</td>
<td>64位无符号整数，小端存储</td>
</tr>
<tr>
<td>sleb128</td>
<td>有符号 LEB128，可变长度</td>
</tr>
<tr>
<td>uleb128</td>
<td>无符号 LEB128，可变长度</td>
</tr>
<tr>
<td>uleb128p1</td>
<td>无符号 LEB128 加 1，可变长度</td>
</tr>
</tbody>
</table>
<p>[<strong>注</strong>] 将一个数编码为 uleb128p1 时需要将 uleb128 加 1，而将一个已经编码好的 uleb128p1 解码为正常数字时需要将 uleb128 减 1。</p>
<h2 id="LEB128？">LEB128？</h2><p>LEB128，全程 <strong>L</strong>ittle-<strong>E</strong>ndian <strong>B</strong>ase <strong>128</strong>，借鉴自 <a href="http://dwarfstd.org/Dwarf3Std.php" target="_blank" rel="external">DWARF3</a> (一种调试文件格式，广泛用于 Unix、Linux等操作系统，可扩展性强) 。在 .dex 文件中，LEB128 仅对 32 位数据编码。</p>
<p>每个 LEB128 编码的值由 1-5 个字节组成，合在一起表示一个 32 位的值。每个字节的有效位只有7位，最高位作为标记：最后一个字节的最高位设为0，其余设为1 。如果第 5 个字节的最高位为 1，说明这个 dex 文件是无效的。</p>
<p>sleb128 对最后一个字节的最高位进行了符号扩展(高位全补1，uleb128是高位全补0)，即作为符号位。</p>
<p>uleb128p1 + 1 就是 uleb128 的值，也就是说在无符号 LEB128 类型中，只有非负数和一个负数(-1 or 0xffffffff)。</p>
<p>下面是 2 个字节的 LEB128 值 - 图示：</p>
<table>
<thead>
<tr>
<th>First byte</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>bit6</td>
<td>bit5</td>
<td>bit4</td>
<td>bit3</td>
<td>bit2</td>
<td>bit1</td>
<td>bit0</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>Second byte</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>bit13</td>
<td>bit12</td>
<td>bit12</td>
<td>bit11</td>
<td>bit10</td>
<td>bit9</td>
<td>bit8</td>
<td>bit7</td>
</tr>
</tbody>
</table>
<p><strong>官方栗子：</strong></p>
<table>
<thead>
<tr>
<th>Encoded Sequence</th>
<th>As sleb128</th>
<th>As uleb128</th>
<th>As uleb128p1</th>
</tr>
</thead>
<tbody>
<tr>
<td>00</td>
<td>0</td>
<td>0</td>
<td>-1</td>
</tr>
<tr>
<td>01</td>
<td>1</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>7f</td>
<td>-1</td>
<td>127</td>
<td>126</td>
</tr>
<tr>
<td>807f</td>
<td>-128</td>
<td>16256</td>
<td>16255</td>
</tr>
</tbody>
</table>
<p><strong>解析：</strong></p>
<table>
<thead>
<tr>
<th>7f</th>
</tr>
</thead>
<tbody>
<tr>
<td>二进制</td>
<td>0111,1111</td>
</tr>
<tr>
<td>有效值</td>
<td>111,1111</td>
</tr>
<tr>
<td>sleb128</td>
<td>1111,1111 = - 0000,0000,0000,0001  = -1</td>
</tr>
<tr>
<td>uleb128</td>
<td>0111,1111 = 127</td>
</tr>
<tr>
<td>uleb128p1</td>
<td>127-1=126</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>80 7f</th>
</tr>
</thead>
<tbody>
<tr>
<td>二进制</td>
<td>1000,0000,0111,1111</td>
</tr>
<tr>
<td>有效值</td>
<td>111,1111,000,0000</td>
</tr>
<tr>
<td>sleb128</td>
<td>1111,1111,1000,0000 = - 0000,0000,1000,0000  = -128</td>
</tr>
<tr>
<td>uleb128</td>
<td>0011,1111,1000,0000 = 16256</td>
</tr>
<tr>
<td>uleb128p1</td>
<td>16256-1=16255</td>
</tr>
</tbody>
</table>
<h2 id="相关源码">相关源码</h2><p>位于 <code>/dalvik/libdex/Leb128.h</code> 文件中。</p>
<h3 id="读取无符号_LEB128_的源码">读取无符号 LEB128 的源码</h3><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * <span class="type">Reads</span> an unsigned <span class="type">LEB128</span> value, updating the given <span class="type">pointer</span> to point</span><br><span class="line"> * just past the <span class="keyword">end</span> <span class="keyword">of</span> the read value. <span class="type">This</span> function tolerates</span><br><span class="line"> * non-zero high-order bits <span class="keyword">in</span> the fifth encoded byte.</span><br><span class="line"> */</span><br><span class="line"><span class="type">DEX_INLINE</span> <span class="type">int</span> readUnsignedLeb128(<span class="keyword">const</span> u1** pStream) &#123;</span><br><span class="line">    <span class="keyword">const</span> u1* <span class="keyword">ptr</span> = *pStream;</span><br><span class="line">    <span class="type">int</span> <span class="literal">result</span> = *(<span class="keyword">ptr</span>++);      //取第一个字节</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">result</span> &gt; <span class="number">0x7f</span>) &#123;        //如果大于 <span class="number">0x7f</span> 表示第 <span class="number">1</span> 字节最高位为 <span class="number">1</span></span><br><span class="line">        <span class="type">int</span> cur = *(<span class="keyword">ptr</span>++);     //取第二个字节</span><br><span class="line">        <span class="literal">result</span> = (<span class="literal">result</span> &amp; <span class="number">0x7f</span>) | ((cur &amp; <span class="number">0x7f</span>) &lt;&lt; <span class="number">7</span>);     // 两个字节组合，第二个字节为高位</span><br><span class="line">        <span class="keyword">if</span> (cur &gt; <span class="number">0x7f</span>) &#123;        //如果大于 <span class="number">0x7f</span> 表示第 <span class="number">2</span> 字节最高位为 <span class="number">1</span></span><br><span class="line">            cur = *(<span class="keyword">ptr</span>++);      //取第三个字节</span><br><span class="line">            <span class="literal">result</span> |= (cur &amp; <span class="number">0x7f</span>) &lt;&lt; <span class="number">14</span>;           //前三个字节组合，第三个字节为高位</span><br><span class="line">            <span class="keyword">if</span> (cur &gt; <span class="number">0x7f</span>) &#123;        //如果大于 <span class="number">0x7f</span> 表示第 <span class="number">3</span> 字节最高位为 <span class="number">1</span></span><br><span class="line">                cur = *(<span class="keyword">ptr</span>++);      //取第四个字节</span><br><span class="line">                <span class="literal">result</span> |= (cur &amp; <span class="number">0x7f</span>) &lt;&lt; <span class="number">21</span>;       //前四个字节组合，第四个字节为高位</span><br><span class="line">                <span class="keyword">if</span> (cur &gt; <span class="number">0x7f</span>) &#123;       //如果大于 <span class="number">0x7f</span> 表示第 <span class="number">4</span> 字节最高位为 <span class="number">1</span></span><br><span class="line">                    /*</span><br><span class="line">                     * 这里不检查 <span class="keyword">ptr</span> 指针是否越界</span><br><span class="line">                     * 也不检查第五个字节的最高位是否为<span class="number">0</span></span><br><span class="line">                     */</span><br><span class="line">                    cur = *(<span class="keyword">ptr</span>++);                //取第五个字节</span><br><span class="line">                    <span class="literal">result</span> |= cur &lt;&lt; <span class="number">28</span>;           //前五个字节组合，第五个字节为高位</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *pStream = <span class="keyword">ptr</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">result</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="读取有符号_LEB128_的源码">读取有符号 LEB128 的源码</h3><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * <span class="type">Reads</span> a signed <span class="type">LEB128</span> value, updating the given <span class="type">pointer</span> to point</span><br><span class="line"> * just past the <span class="keyword">end</span> <span class="keyword">of</span> the read value. <span class="type">This</span> function tolerates</span><br><span class="line"> * non-zero high-order bits <span class="keyword">in</span> the fifth encoded byte.</span><br><span class="line"> */</span><br><span class="line"><span class="type">DEX_INLINE</span> <span class="type">int</span> readSignedLeb128(<span class="keyword">const</span> u1** pStream) &#123;</span><br><span class="line">    <span class="keyword">const</span> u1* <span class="keyword">ptr</span> = *pStream;</span><br><span class="line">    <span class="type">int</span> <span class="literal">result</span> = *(<span class="keyword">ptr</span>++);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">result</span> &lt;= <span class="number">0x7f</span>) &#123;   //第<span class="number">2</span>个字节最高位为<span class="number">0</span></span><br><span class="line">        <span class="literal">result</span> = (<span class="literal">result</span> &lt;&lt; <span class="number">25</span>) &gt;&gt; <span class="number">25</span>;  //最高位进行符号扩展</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">int</span> cur = *(<span class="keyword">ptr</span>++);</span><br><span class="line">        <span class="literal">result</span> = (<span class="literal">result</span> &amp; <span class="number">0x7f</span>) | ((cur &amp; <span class="number">0x7f</span>) &lt;&lt; <span class="number">7</span>); //前两个字节组合</span><br><span class="line">        <span class="keyword">if</span> (cur &lt;= <span class="number">0x7f</span>) &#123;   //第<span class="number">2</span>个字节最高位为<span class="number">0</span></span><br><span class="line">            <span class="literal">result</span> = (<span class="literal">result</span> &lt;&lt; <span class="number">18</span>) &gt;&gt; <span class="number">18</span>;   //最高位进行符号扩展</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            cur = *(<span class="keyword">ptr</span>++);</span><br><span class="line">            <span class="literal">result</span> |= (cur &amp; <span class="number">0x7f</span>) &lt;&lt; <span class="number">14</span>;   //前<span class="number">3</span>个字节组合</span><br><span class="line">            <span class="keyword">if</span> (cur &lt;= <span class="number">0x7f</span>) &#123;   //第<span class="number">3</span>个字节最高位为<span class="number">0</span></span><br><span class="line">                <span class="literal">result</span> = (<span class="literal">result</span> &lt;&lt; <span class="number">11</span>) &gt;&gt; <span class="number">11</span>;   //最高位进行符号扩展</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                cur = *(<span class="keyword">ptr</span>++);</span><br><span class="line">                <span class="literal">result</span> |= (cur &amp; <span class="number">0x7f</span>) &lt;&lt; <span class="number">21</span>;    //前<span class="number">4</span>个字节组合</span><br><span class="line">                <span class="keyword">if</span> (cur &lt;= <span class="number">0x7f</span>) &#123;     //第<span class="number">4</span>个字节最高位为<span class="number">0</span></span><br><span class="line">                    <span class="literal">result</span> = (<span class="literal">result</span> &lt;&lt; <span class="number">4</span>) &gt;&gt; <span class="number">4</span>;   //最高位进行符号扩展</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    cur = *(<span class="keyword">ptr</span>++);</span><br><span class="line">                    <span class="literal">result</span> |= cur &lt;&lt; <span class="number">28</span>;    //前<span class="number">5</span>个字节组合</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *pStream = <span class="keyword">ptr</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">result</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Reference">Reference</h2><p><a href="https://source.android.com/devices/tech/dalvik/dex-format.html" target="_blank" rel="external">Dalvik Executable format</a></p>
<p><a href="http://www.ituring.com.cn/book/1131" target="_blank" rel="external">《Android 软件安全与逆向分析》</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<h2 id="引言">引言</h2><p>dex 文件中用到的数据类型有:</p>]]>
    
    </summary>
    
      <category term="Android 安全" scheme="http://kiya-z.github.io/tags/Android-%E5%AE%89%E5%85%A8/"/>
    
      <category term="dex" scheme="http://kiya-z.github.io/tags/dex/"/>
    
      <category term="Android" scheme="http://kiya-z.github.io/categories/Android/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[解析 dex 文件结构 - map_list]]></title>
    <link href="http://kiya-z.github.io/2015/11/18/parse-dex-file-part-map-list/"/>
    <id>http://kiya-z.github.io/2015/11/18/parse-dex-file-part-map-list/</id>
    <published>2015-11-18T09:06:28.000Z</published>
    <updated>2015-11-21T14:38:34.294Z</updated>
    <content type="html"><![CDATA[<p><img src="http://7xo976.com1.z0.glb.clouddn.com/images/github-io/Android/dex-file-general-structure-map-list.png" alt="map-list"></p>
<a id="more"></a>
<h2 id="什么是_map_list？">什么是 map_list？</h2><p>整个 dex 文件的内容清单，位于数据段内，其文件偏移由 DexHeader 中的 mapOff 字段指定。</p>
<p>更加具体的解释在下面的 type 段落部分。</p>
<hr>
<h2 id="结构">结构</h2><p>来到 mapOff 指定的偏移处，首先是 DexMapList 结构，存储了 map_list 内 map_item (DexMapItem) 的个数和内容，也就是说在 size 之后，有 size 个DexMapItem 类型的数据。</p>
<h3 id="DexMapList">DexMapList</h3><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> Direct-mapped <span class="string">"map_list"</span>.</span><br><span class="line"> <span class="keyword">*</span>/</span><br><span class="line">struct DexMapList &#123;</span><br><span class="line">    u4  size;               /<span class="keyword">*</span> DexMapItem 的个数 <span class="keyword">*</span>/</span><br><span class="line">    DexMapItem list[1];     /<span class="keyword">*</span> DexMapItem 数组 <span class="keyword">*</span>/</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="DexMapItem">DexMapItem</h3><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> Direct-mapped <span class="string">"map_item"</span>.</span><br><span class="line"> <span class="keyword">*</span>/</span><br><span class="line">struct DexMapItem &#123;</span><br><span class="line">    u2 type;              /<span class="keyword">*</span> 各 item 的类型，均以 kDexType 开头<span class="keyword">*</span>/</span><br><span class="line">    u2 unused;            /<span class="keyword">*</span> 未使用，用于字节对齐 <span class="keyword">*</span>/</span><br><span class="line">    u4 size;              /<span class="keyword">*</span> 指定类型的个数 <span class="keyword">*</span>/</span><br><span class="line">    u4 offset;            /<span class="keyword">*</span> 指定类型数据的起始文件偏移 <span class="keyword">*</span>/</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="type">type</h3><p>在这些类型中，除了 0x0000 表示的就是 DexHeader 本身之外，0x0001 ~ 0x1000 部分与 DexHeader 中定义的类型是一致的；<br>而 0x1001 ~ 0x2006 部分是对 data 段的细分。<br>这样设计可以作为一种文件检验方式，一旦和 DexHeader 的数据有所不同就可以判定该 dex 是损坏的；而且 map_list 部分的内容更详细，以此作为整个文件的索引想必是极好的。<br>下面手动查找的例子可以证明。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* map item type codes */</span></span><br><span class="line"><span class="keyword">enum</span> &#123;</span><br><span class="line">    kDexTypeHeaderItem               = <span class="number">0x0000</span>,</span><br><span class="line">    kDexTypeStringIdItem             = <span class="number">0x0001</span>,</span><br><span class="line">    kDexTypeTypeIdItem               = <span class="number">0x0002</span>,</span><br><span class="line">    kDexTypeProtoIdItem              = <span class="number">0x0003</span>,</span><br><span class="line">    kDexTypeFieldIdItem              = <span class="number">0x0004</span>,</span><br><span class="line">    kDexTypeMethodIdItem             = <span class="number">0x0005</span>,</span><br><span class="line">    kDexTypeClassDefItem             = <span class="number">0x0006</span>,</span><br><span class="line">    kDexTypeMapList                  = <span class="number">0x1000</span>,</span><br><span class="line">    kDexTypeTypeList                 = <span class="number">0x1001</span>,</span><br><span class="line">    kDexTypeAnnotationSetRefList     = <span class="number">0x1002</span>,</span><br><span class="line">    kDexTypeAnnotationSetItem        = <span class="number">0x1003</span>,</span><br><span class="line">    kDexTypeClassDataItem            = <span class="number">0x2000</span>,</span><br><span class="line">    kDexTypeCodeItem                 = <span class="number">0x2001</span>,</span><br><span class="line">    kDexTypeStringDataItem           = <span class="number">0x2002</span>,</span><br><span class="line">    kDexTypeDebugInfoItem            = <span class="number">0x2003</span>,</span><br><span class="line">    kDexTypeAnnotationItem           = <span class="number">0x2004</span>,</span><br><span class="line">    kDexTypeEncodedArrayItem         = <span class="number">0x2005</span>,</span><br><span class="line">    kDexTypeAnnotationsDirectoryItem = <span class="number">0x2006</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="手工查找">手工查找</h2><p><strong>某 dex 文件的 map_list 部分</strong>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00001000</span>  <span class="number">10</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |................|</span><br><span class="line"><span class="number">00001010</span>  <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">5</span>c <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">70</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">02</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |....\...p.......|</span><br><span class="line"><span class="number">00001020</span>  <span class="number">19</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> e0 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">03</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">12</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |................|</span><br><span class="line"><span class="number">00001030</span>  <span class="number">44</span> <span class="number">02</span> <span class="number">00</span> <span class="number">00</span> <span class="number">04</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">1</span>c <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>  |D...............|</span><br><span class="line"><span class="number">00001040</span>  <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">2</span>b <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">24</span> <span class="number">03</span> <span class="number">00</span> <span class="number">00</span> <span class="number">06</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |....+...$.......|</span><br><span class="line"><span class="number">00001050</span>  <span class="number">02</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">7</span>c <span class="number">04</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">02</span> <span class="number">20</span> <span class="number">00</span> <span class="number">00</span> <span class="number">5</span>c <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |....|.... ..\...|</span><br><span class="line"><span class="number">00001060</span>  bc <span class="number">04</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> <span class="number">10</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">0</span>a <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> f8 <span class="number">09</span> <span class="number">00</span> <span class="number">00</span>  |................|</span><br><span class="line"><span class="number">00001070</span>  <span class="number">04</span> <span class="number">20</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">4</span>e <span class="number">0</span>a <span class="number">00</span> <span class="number">00</span> <span class="number">03</span> <span class="number">10</span> <span class="number">00</span> <span class="number">00</span>  |. ......N.......|</span><br><span class="line"><span class="number">00001080</span>  <span class="number">02</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">58</span> <span class="number">0</span>a <span class="number">00</span> <span class="number">00</span>  <span class="number">06</span> <span class="number">20</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |....X.... ......|</span><br><span class="line"><span class="number">00001090</span>  <span class="number">64</span> <span class="number">0</span>a <span class="number">00</span> <span class="number">00</span> <span class="number">03</span> <span class="number">20</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">09</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">7</span>c <span class="number">0</span>a <span class="number">00</span> <span class="number">00</span>  |d.... ......|...|</span><br><span class="line"><span class="number">000010</span>a0  <span class="number">01</span> <span class="number">20</span> <span class="number">00</span> <span class="number">00</span> <span class="number">09</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">10</span> <span class="number">0</span>c <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">20</span> <span class="number">00</span> <span class="number">00</span>  |. ........... ..|</span><br><span class="line"><span class="number">000010</span>b0  <span class="number">02</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> c2 <span class="number">0f</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">10</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |................|</span><br><span class="line"><span class="number">000010</span>c0  <span class="number">00</span> <span class="number">10</span> <span class="number">00</span> <span class="number">00</span>                                       |....|</span><br></pre></td></tr></table></figure>
<p>前 4 字节表明接下来会有 <code>0x00000010</code> 个 DexMapItem 结构；</p>
<table>
<thead>
<tr>
<th>序数</th>
<th>binary</th>
<th>type</th>
<th>size</th>
<th>offset</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x01</td>
<td>00 00 00 00  01 00 00 00  00 00 00 00</td>
<td>kDexTypeHeaderItem</td>
<td>0x01</td>
<td>0x0</td>
</tr>
<tr>
<td>0x02</td>
<td>01 00 00 00  5c 00 00 00  70 00 00 00</td>
<td>kDexTypeStringIdItem</td>
<td>0x5c</td>
<td>0x70</td>
</tr>
<tr>
<td>0x03</td>
<td>02 00 00 00  19 00 00 00  e0 01 00 00</td>
<td>kDexTypeTypeIdItem</td>
<td>0x19</td>
<td>0x1e0</td>
</tr>
<tr>
<td>0x04</td>
<td>03 00 00 00  12 00 00 00  44 02 00 00</td>
<td>kDexTypeProtoIdItem</td>
<td>0x12</td>
<td>0x244</td>
</tr>
<tr>
<td>0x05</td>
<td>04 00 00 00  01 00 00 00  1c 03 00 00</td>
<td>kDexTypeFieldIdItem</td>
<td>0x01</td>
<td>0x3c1</td>
</tr>
<tr>
<td>0x06</td>
<td>05 00 00 00  2b 00 00 00  24 03 00 00</td>
<td>kDexTypeMethodIdItem</td>
<td>0x2b</td>
<td>0x324</td>
</tr>
<tr>
<td>0x07</td>
<td>06 00 00 00  02 00 00 00  7c 04 00 00</td>
<td>kDexTypeClassDefItem</td>
<td>0x02</td>
<td>0x47c</td>
</tr>
<tr>
<td>0x08</td>
<td>02 20 00 00  5c 00 00 00  bc 04 00 00</td>
<td>kDexTypeStringDataItem</td>
<td>0x5c</td>
<td>0x4bc</td>
</tr>
<tr>
<td>0x09</td>
<td>01 10 00 00  0a 00 00 00  f8 09 00 00</td>
<td>kDexTypeTypeList</td>
<td>0x0a</td>
<td>0x9f8</td>
</tr>
<tr>
<td>0x0a</td>
<td>04 20 00 00  01 00 00 00  4e 0a 00 00</td>
<td>kDexTypeAnnotationItem</td>
<td>0x01</td>
<td>0xa4e</td>
</tr>
<tr>
<td>0x0b</td>
<td>03 10 00 00  02 00 00 00  58 0a 00 00</td>
<td>kDexTypeAnnotationSetItem</td>
<td>0x02</td>
<td>0xa58</td>
</tr>
<tr>
<td>0x0c</td>
<td>06 20 00 00  01 00 00 00  64 0a 00 00</td>
<td>kDexTypeAnnotationsDirectoryItem</td>
<td>0x01</td>
<td>0xa64</td>
</tr>
<tr>
<td>0x0d</td>
<td>03 20 00 00  09 00 00 00  7c 0a 00 00</td>
<td>kDexTypeDebugInfoItem</td>
<td>0x09</td>
<td>0xa7c</td>
</tr>
<tr>
<td>0x0e</td>
<td>01 20 00 00  09 00 00 00  10 0c 00 00</td>
<td>kDexTypeCodeItem</td>
<td>0x09</td>
<td>0xc10</td>
</tr>
<tr>
<td>0x0f</td>
<td>00 20 00 00  02 00 00 00  c2 0f 00 00</td>
<td>kDexTypeClassDataItem</td>
<td>0x02</td>
<td>0xfc2</td>
</tr>
<tr>
<td>0x10</td>
<td>00 10 00 00  01 00 00 00  00 10 00 00</td>
<td>kDexTypeMapList</td>
<td>0x01</td>
<td>0x1000</td>
</tr>
</tbody>
</table>
<p>这里的各项值可以和上一节 <a href="http://kiya-z.github.io/2015/11/17/parse-dex-file-part-dex-header/">解析 dex 文件结构 - DexHeader</a> 手动查找部分中的数据进行比对，发现是相同的。</p>
<hr>
<h2 id="写程序解析_map_list">写程序解析 map_list</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DexStruct</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    DexMapList = &#123;</span><br><span class="line">        <span class="string">"size"</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="string">"DexMapItem"</span>: []</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># DexMapItem = &#123;</span></span><br><span class="line">    <span class="comment">#     "type" : 0</span></span><br><span class="line">    <span class="comment">#     "unused" : 0</span></span><br><span class="line">    <span class="comment">#     "size"  : 0</span></span><br><span class="line">    <span class="comment">#     "offset" : 0</span></span><br><span class="line">    <span class="comment"># &#125;</span></span><br><span class="line"></span><br><span class="line">    DexMapItemCode = &#123;</span><br><span class="line">        <span class="number">0x0000</span> : <span class="string">"kDexTypeHeaderItem"</span>               ,</span><br><span class="line">        <span class="number">0x0001</span> : <span class="string">"kDexTypeStringIdItem"</span>             ,</span><br><span class="line">        <span class="number">0x0002</span> : <span class="string">"kDexTypeTypeIdItem"</span>               ,</span><br><span class="line">        <span class="number">0x0003</span> : <span class="string">"kDexTypeProtoIdItem"</span>              ,</span><br><span class="line">        <span class="number">0x0004</span> : <span class="string">"kDexTypeFieldIdItem"</span>              ,</span><br><span class="line">        <span class="number">0x0005</span> : <span class="string">"kDexTypeMethodIdItem"</span>             ,</span><br><span class="line">        <span class="number">0x0006</span> : <span class="string">"kDexTypeClassDefItem"</span>             ,</span><br><span class="line">        <span class="number">0x1000</span> : <span class="string">"kDexTypeMapList"</span>                  ,</span><br><span class="line">        <span class="number">0x1001</span> : <span class="string">"kDexTypeTypeList"</span>                 ,</span><br><span class="line">        <span class="number">0x1002</span> : <span class="string">"kDexTypeAnnotationSetRefList"</span>     ,</span><br><span class="line">        <span class="number">0x1003</span> : <span class="string">"kDexTypeAnnotationSetItem"</span>        ,</span><br><span class="line">        <span class="number">0x2000</span> : <span class="string">"kDexTypeClassDataItem"</span>            ,</span><br><span class="line">        <span class="number">0x2001</span> : <span class="string">"kDexTypeCodeItem"</span>                 ,</span><br><span class="line">        <span class="number">0x2002</span> : <span class="string">"kDexTypeStringDataItem"</span>           ,</span><br><span class="line">        <span class="number">0x2003</span> : <span class="string">"kDexTypeDebugInfoItem"</span>            ,</span><br><span class="line">        <span class="number">0x2004</span> : <span class="string">"kDexTypeAnnotationItem"</span>           ,</span><br><span class="line">        <span class="number">0x2005</span> : <span class="string">"kDexTypeEncodedArrayItem"</span>         ,</span><br><span class="line">        <span class="number">0x2006</span> : <span class="string">"kDexTypeAnnotationsDirectoryItem"</span> ,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parseMapList</span><span class="params">(map_data)</span>:</span></span><br><span class="line">    DexStruct.DexMapList[<span class="string">'size'</span>] = struct.unpack(<span class="string">'H'</span>,map_data[:<span class="number">2</span>])[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    curPos = <span class="number">4</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(DexStruct.DexMapList[<span class="string">'size'</span>]):</span><br><span class="line">        tmpDexMapItem = &#123;</span><br><span class="line">            <span class="string">"type"</span> : struct.unpack(<span class="string">'H'</span>,map_data[curPos:curPos+<span class="number">2</span>])[<span class="number">0</span>],</span><br><span class="line">            <span class="string">"unused"</span> : <span class="number">0</span>,</span><br><span class="line">            <span class="string">"size"</span>  : struct.unpack(<span class="string">'I'</span>,map_data[curPos+<span class="number">4</span>:curPos+<span class="number">8</span>])[<span class="number">0</span>],</span><br><span class="line">            <span class="string">"offset"</span> : struct.unpack(<span class="string">'I'</span>,map_data[curPos+<span class="number">8</span>:curPos+<span class="number">12</span>])[<span class="number">0</span>] &#125;</span><br><span class="line">        curPos += <span class="number">12</span></span><br><span class="line">        DexStruct.DexMapList[<span class="string">"DexMapItem"</span>].append(tmpDexMapItem)</span><br></pre></td></tr></table></figure>
<h2 id="Reference">Reference</h2><p><a href="https://source.android.com/devices/tech/dalvik/dex-format.html" target="_blank" rel="external">Dalvik Executable format</a></p>
<p><a href="http://www.ituring.com.cn/book/1131" target="_blank" rel="external">《Android 软件安全与逆向分析》</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<p><img src="http://7xo976.com1.z0.glb.clouddn.com/images/github-io/Android/dex-file-general-structure-map-list.png" alt="map-list"></p>]]>
    
    </summary>
    
      <category term="Android 安全" scheme="http://kiya-z.github.io/tags/Android-%E5%AE%89%E5%85%A8/"/>
    
      <category term="dex" scheme="http://kiya-z.github.io/tags/dex/"/>
    
      <category term="Android" scheme="http://kiya-z.github.io/categories/Android/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[解析 dex 文件结构 - DexHeader]]></title>
    <link href="http://kiya-z.github.io/2015/11/17/parse-dex-file-part-dex-header/"/>
    <id>http://kiya-z.github.io/2015/11/17/parse-dex-file-part-dex-header/</id>
    <published>2015-11-17T14:32:58.000Z</published>
    <updated>2015-11-22T17:00:55.538Z</updated>
    <content type="html"><![CDATA[<p><img src="http://7xo976.com1.z0.glb.clouddn.com/images/github-io/Android/dex-file-general-structure-header.png" alt="header"></p>
<h2 id="dex_简介">dex 简介</h2><p>dex 文件是 dalvik 虚拟机的可执行文件。</p>
<a id="more"></a>
<hr>
<h2 id="dex_文件结构">dex 文件结构</h2><p>该结构位于系统源码 <code>dalvik\libdex\DexFile.h</code> 中，描述的是 dex 文件被映射到内存中的结构。</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> Structure representing a DEX file.</span><br><span class="line"> <span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> Code should regard DexFile as opaque, using the API calls provided here</span><br><span class="line"> <span class="keyword">*</span> to access specific structures.</span><br><span class="line"> <span class="keyword">*</span>/</span><br><span class="line">struct DexFile &#123;</span><br><span class="line">    /<span class="keyword">*</span> directly-mapped <span class="string">"opt"</span> header <span class="keyword">*</span>/</span><br><span class="line">    const DexOptHeader<span class="keyword">*</span> pOptHeader;</span><br><span class="line"></span><br><span class="line">    /<span class="keyword">*</span> pointers to directly-mapped structs and arrays in base DEX <span class="keyword">*</span>/</span><br><span class="line">    const DexHeader<span class="keyword">*</span>    pHeader;</span><br><span class="line">    const DexStringId<span class="keyword">*</span>  pStringIds;</span><br><span class="line">    const DexTypeId<span class="keyword">*</span>    pTypeIds;</span><br><span class="line">    const DexFieldId<span class="keyword">*</span>   pFieldIds;</span><br><span class="line">    const DexMethodId<span class="keyword">*</span>  pMethodIds;</span><br><span class="line">    const DexProtoId<span class="keyword">*</span>   pProtoIds;</span><br><span class="line">    const DexClassDef<span class="keyword">*</span>  pClassDefs;</span><br><span class="line">    const DexLink<span class="keyword">*</span>      pLinkData;</span><br><span class="line"></span><br><span class="line">    /<span class="keyword">*</span></span><br><span class="line">     <span class="keyword">*</span> These are mapped out of the <span class="string">"auxillary"</span> section, and may not be</span><br><span class="line">     <span class="keyword">*</span> included in the file.</span><br><span class="line">     <span class="keyword">*</span>/</span><br><span class="line">    const DexClassLookup<span class="keyword">*</span> pClassLookup;</span><br><span class="line">    const void<span class="keyword">*</span>         pRegisterMapPool;       // RegisterMapClassPool</span><br><span class="line"></span><br><span class="line">    /<span class="keyword">*</span> points to start of DEX file data <span class="keyword">*</span>/</span><br><span class="line">    const u1<span class="keyword">*</span>           baseAddr;</span><br><span class="line"></span><br><span class="line">    /<span class="keyword">*</span> track memory overhead for auxillary structures <span class="keyword">*</span>/</span><br><span class="line">    int                 overhead;</span><br><span class="line"></span><br><span class="line">    /<span class="keyword">*</span> additional app-specific data structures associated with the DEX <span class="keyword">*</span>/</span><br><span class="line">    //void<span class="keyword">*</span>               auxData;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>基本的文件结构只需关注:<br><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">struct DexFile&#123;</span><br><span class="line">    DexHeader    Header<span class="comment">;</span></span><br><span class="line">    DexStringId  StringIds[stringIdsSize]<span class="comment">;</span></span><br><span class="line">    DexTypeId    TypeIds[typeIdsSize]<span class="comment">;</span></span><br><span class="line">    DexFieldId   FieldIds[fieldIdsSize]<span class="comment">;</span></span><br><span class="line">    DexMethodId  MethodIds[methodIdsSize]<span class="comment">;</span></span><br><span class="line">    DexProtoId   ProtoIds[protoIdsSize]<span class="comment">;</span></span><br><span class="line">    DexClassDef  ClassDefs[classDefsSize]<span class="comment">;</span></span><br><span class="line">    DexData      Data[]<span class="comment">;</span></span><br><span class="line">    DexLink      LinkData<span class="comment">;</span></span><br><span class="line">&#125;<span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="大体结构图">大体结构图</h3><p><img src="http://7xo976.com1.z0.glb.clouddn.com/images/github-io/Android/dex-file-general-structure.png" alt="dex-file-general-structure"></p>
<p>大致可以将 dex 文件分为三个部分：DexHeader 、Table 是索引结构区 、data 部分是数据区。<br>程序使用到的数据都在 data section 内， Tables 是指向 data section 中具体数据结构的索引。</p>
<hr>
<h2 id="DexHeader_结构">DexHeader 结构</h2><p>头部记录了整个文件的索引。</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> 160-bit SHA-1 digest.</span><br><span class="line"> <span class="keyword">*</span>/</span><br><span class="line">enum &#123; kSHA1DigestLen = 20,</span><br><span class="line">       kSHA1DigestOutputLen = kSHA1DigestLen<span class="keyword">*</span>2 +1 &#125;;</span><br><span class="line"></span><br><span class="line">/<span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> Direct-mapped <span class="string">"header_item"</span> struct.</span><br><span class="line"> <span class="keyword">*</span>/</span><br><span class="line">struct DexHeader &#123;</span><br><span class="line">    u1  magic[8];           /<span class="keyword">*</span> 版本标识 <span class="keyword">*</span>/</span><br><span class="line">    u4  checksum;           /<span class="keyword">*</span> adler32 检验 <span class="keyword">*</span>/</span><br><span class="line">    u1  signature[kSHA1DigestLen]; /<span class="keyword">*</span> SHA-1 哈希值 <span class="keyword">*</span>/</span><br><span class="line">    u4  fileSize;           /<span class="keyword">*</span> 整个文件大小 <span class="keyword">*</span>/</span><br><span class="line">    u4  headerSize;         /<span class="keyword">*</span> DexHeader 大小 <span class="keyword">*</span>/</span><br><span class="line">    u4  endianTag;          /<span class="keyword">*</span> 字节序标记 <span class="keyword">*</span>/</span><br><span class="line">    u4  linkSize;           /<span class="keyword">*</span> 链接段大小 <span class="keyword">*</span>/</span><br><span class="line">    u4  linkOff;            /<span class="keyword">*</span> 链接段偏移 <span class="keyword">*</span>/</span><br><span class="line">    u4  mapOff;             /<span class="keyword">*</span> DexMapList 的文件偏移 <span class="keyword">*</span>/</span><br><span class="line">    u4  stringIdsSize;      /<span class="keyword">*</span> DexStringId 的个数 <span class="keyword">*</span>/</span><br><span class="line">    u4  stringIdsOff;       /<span class="keyword">*</span> DexStringId 的文件偏移 <span class="keyword">*</span>/</span><br><span class="line">    u4  typeIdsSize;        /<span class="keyword">*</span> DexTypeId 的个数 <span class="keyword">*</span>/</span><br><span class="line">    u4  typeIdsOff;         /<span class="keyword">*</span> DexTypeId 的文件偏移 <span class="keyword">*</span>/</span><br><span class="line">    u4  protoIdsSize;       /<span class="keyword">*</span> DexProtoId 的个数 <span class="keyword">*</span>/</span><br><span class="line">    u4  protoIdsOff;        /<span class="keyword">*</span> DexProtoId 的文件偏移 <span class="keyword">*</span>/</span><br><span class="line">    u4  fieldIdsSize;       /<span class="keyword">*</span> DexFieldId 的个数 <span class="keyword">*</span>/</span><br><span class="line">    u4  fieldIdsOff;        /<span class="keyword">*</span> DexFieldId 的文件偏移 <span class="keyword">*</span>/</span><br><span class="line">    u4  methodIdsSize;      /<span class="keyword">*</span> DexMethodId 的个数 <span class="keyword">*</span>/</span><br><span class="line">    u4  methodIdsOff;       /<span class="keyword">*</span> DexMethodId 的文件偏移 <span class="keyword">*</span>/</span><br><span class="line">    u4  classDefsSize;      /<span class="keyword">*</span> DexClassDef 的个数 <span class="keyword">*</span>/</span><br><span class="line">    u4  classDefsOff;       /<span class="keyword">*</span> DexClassDef 的文件偏移 <span class="keyword">*</span>/</span><br><span class="line">    u4  dataSize;           /<span class="keyword">*</span> 数据段的大小 <span class="keyword">*</span>/</span><br><span class="line">    u4  dataOff;            /<span class="keyword">*</span> 数据段的文件偏移 <span class="keyword">*</span>/</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="其中：">其中：</h3><table>
<thead>
<tr>
<th>field</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>magic</strong></td>
<td>dex文件标识，值必须为常量 <code>DEX_FILE_MAGIC</code> = { 0x64 0x65 0x78 0x0a 0x30 0x33 0x35 0x00 } = “dex\n035\0”</td>
</tr>
<tr>
<td><strong>checkSum</strong></td>
<td>对除 magic 和 checkSum 外的剩余文件计算 adler32 校验值，目的是检测文件是否损坏</td>
</tr>
<tr>
<td><strong> signature</strong></td>
<td>对除 magic、checkSum 和 signature 外的剩余文件计算 SHA-1 校验值，用来确定文件的唯一性</td>
</tr>
<tr>
<td><strong> fileSize</strong></td>
<td>以字节为单位，整个文件（包括头部）的大小</td>
</tr>
<tr>
<td><strong> headerSize</strong></td>
<td>头部大小，0x70 字节，已经考虑到兼容性</td>
</tr>
<tr>
<td><strong> endianTag</strong></td>
<td>两种字节序取值: <code>uint ENDIAN_CONSTANT = 0x12345678</code> ; <code>uint REVERSE_ENDIAN_CONSTANT = 0x78563412</code></td>
</tr>
<tr>
<td><strong> linkSize</strong></td>
<td>链接段的大小，如果没有使用静态链接，值为0</td>
</tr>
<tr>
<td><strong> linkOff</strong></td>
<td>链接段的文件偏移，指向链接数据段内，如果 <code>linkSize</code> 为 0，则为 0</td>
</tr>
<tr>
<td><strong> mapOff</strong></td>
<td>map item 的文件偏移，指向数据段内，数据结构为 <code>mapList</code>，如果没有 map，值为 0</td>
</tr>
<tr>
<td><strong> stringIdsSize</strong></td>
<td>字符串 id 的个数</td>
</tr>
<tr>
<td><strong> stringIdsOff</strong></td>
<td>字符串 id 清单的文件偏移，指向 <code>stringIds</code> 的起始地址，如果 stringIdsSize 为 0，值为0</td>
</tr>
<tr>
<td><strong> typeIdsSize</strong></td>
<td>类型标识符的个数</td>
</tr>
<tr>
<td><strong> typeIdsOff</strong></td>
<td>类型标识符清单的文件偏移，指向 <code>typeIds</code> 的起始地址，如果 typeIdsSize 为 0，值为 0 (<em>这就很奇怪了哟</em>)</td>
</tr>
<tr>
<td><strong> protoIdsSize</strong></td>
<td>原型标识符的个数</td>
</tr>
<tr>
<td><strong> protoIdsOff</strong></td>
<td>原型标识符清单的文件偏移，指向 <code>protoIds</code> 的起始地址，如果 protoIdsSize 为 0，值为 0 (<em>这就很奇怪了哟</em>)</td>
</tr>
<tr>
<td><strong>  fieldIdsSize</strong></td>
<td>字段标识符的个数</td>
</tr>
<tr>
<td><strong> fieldIdsOff</strong></td>
<td>字段标识符清单的文件偏移，指向 <code>fieldIds</code> 的起始地址，如果 fieldIdsSize 为 0，值为 0</td>
</tr>
<tr>
<td><strong> methodIdsSize</strong></td>
<td>方法标识符的个数</td>
</tr>
<tr>
<td><strong> methodIdsOff</strong></td>
<td>方法标识符清单的文件偏移，指向 <code>methodIds</code> 的起始地址，如果 methodIdsSize 为 0，值为 0</td>
</tr>
<tr>
<td><strong> classDefsSize</strong></td>
<td>类的个数</td>
</tr>
<tr>
<td><strong> classDefsOff</strong></td>
<td>类清单的文件偏移，指向 <code>classDefs</code> 的起始地址，如果 classDefsSize 为 0，值为 0 (<em>这就很奇怪了哟</em>)</td>
</tr>
<tr>
<td><strong> dataSize</strong></td>
<td>数据段的大小，以字节为单位，并且是 sizeof(uint) 的偶数倍</td>
</tr>
<tr>
<td><strong> dataOff</strong></td>
<td>数据段的文件偏移</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="手工查找">手工查找</h2><p>更方便的方式是使用 <a href="http://www.sweetscape.com/download/010editor/" target="_blank" rel="external">010 Editor</a>，下载其官网上可解析 dex 文件的<a href="http://www.sweetscape.com/010editor/templates/" target="_blank" rel="external">脚本文件</a>，可高亮相应的二进制。</p>
<p>linux 下可以使用 <code>hexdump</code> 查看某文件的二进制数据 -&gt; <code>hexdump -C classes.dex</code></p>
<p><a href="http://archive.oreilly.com/linux/cmd/cmd.csp?path=h/hexdump" target="_blank" rel="external">常用选项</a></p>
<table>
<thead>
<tr>
<th>option</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>-b</td>
<td>将每个字节显示为8进制</td>
</tr>
<tr>
<td>-c</td>
<td>将每个字节显示为ASCII字符</td>
</tr>
<tr>
<td>-C</td>
<td>每个字节显示为16进制和相应的ASCII字符</td>
</tr>
<tr>
<td>-d</td>
<td>每两个字节显示为10进制</td>
</tr>
<tr>
<td>-o</td>
<td>每两个字节显示为8进制</td>
</tr>
<tr>
<td>-x</td>
<td>每两个字节显示为16进制</td>
</tr>
</tbody>
</table>
<p><strong>某 dex 文件的头部：</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span>  <span class="number">64</span> <span class="number">65</span> <span class="number">78</span> <span class="number">0</span>a <span class="number">30</span> <span class="number">33</span> <span class="number">35</span> <span class="number">00</span>  <span class="number">3</span>b ba fe c3 <span class="number">83</span> <span class="number">7</span>e aa be  |dex<span class="number">.035</span>.;....~..|</span><br><span class="line"><span class="number">00000010</span>  <span class="number">09</span> <span class="number">97</span> <span class="number">71</span> <span class="number">1</span>e <span class="number">17</span> <span class="number">96</span> <span class="number">9f</span> e9  <span class="number">0</span>c bd <span class="number">01</span> <span class="number">60</span> b4 <span class="number">2</span>a <span class="number">1</span>a c9  |..q........`.*..|</span><br><span class="line"><span class="number">00000020</span>  c4 <span class="number">10</span> <span class="number">00</span> <span class="number">00</span> <span class="number">70</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">78</span> <span class="number">56</span> <span class="number">34</span> <span class="number">12</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |....p...xV4.....|</span><br><span class="line"><span class="number">00000030</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">10</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">5</span>c <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">70</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |........\...p...|</span><br><span class="line"><span class="number">00000040</span>  <span class="number">19</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> e0 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">12</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">44</span> <span class="number">02</span> <span class="number">00</span> <span class="number">00</span>  |............D...|</span><br><span class="line"><span class="number">00000050</span>  <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">1</span>c <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">2</span>b <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">24</span> <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>  |........+...$...|</span><br><span class="line"><span class="number">00000060</span>  <span class="number">02</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">7</span>c <span class="number">04</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">08</span> <span class="number">0</span>c <span class="number">00</span> <span class="number">00</span> bc <span class="number">04</span> <span class="number">00</span> <span class="number">00</span>  |....|...........|</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>binary</th>
<th>field</th>
</tr>
</thead>
<tbody>
<tr>
<td>64 65 78 0a 30 33 35 00</td>
<td>magic</td>
</tr>
<tr>
<td>3b ba fe c3</td>
<td>checksum</td>
</tr>
<tr>
<td>83 7e aa be 09 97 71 1e 17 96 9f e9 0c bd 01 60 b4 2a 1a c9</td>
<td>signature</td>
</tr>
<tr>
<td>c4 10 00 00</td>
<td>fileSize</td>
</tr>
<tr>
<td>70 00 00 00</td>
<td>headerSize</td>
</tr>
<tr>
<td>78 56 34 12</td>
<td>endianTag</td>
</tr>
<tr>
<td>00 00 00 00</td>
<td>linkSize</td>
</tr>
<tr>
<td>00 00 00 00</td>
<td>linkOff</td>
</tr>
<tr>
<td>00 10 00 00</td>
<td>mapOff</td>
</tr>
<tr>
<td>5c 00 00 00</td>
<td>stringIdsSize</td>
</tr>
<tr>
<td>70 00 00 00</td>
<td>stringIdsOff</td>
</tr>
<tr>
<td>19 00 00 00</td>
<td>typeIdsSize</td>
</tr>
<tr>
<td>e0 01 00 00</td>
<td>typeIdsOff</td>
</tr>
<tr>
<td>12 00 00 00</td>
<td>protoIdsSize</td>
</tr>
<tr>
<td>44 02 00 00</td>
<td>protoIdsOff</td>
</tr>
<tr>
<td>01 00 00 00</td>
<td>fieldIdsSize</td>
</tr>
<tr>
<td>1c 03 00 00</td>
<td>fieldIdsOff</td>
</tr>
<tr>
<td>2b 00 00 00</td>
<td>methodIdsSize</td>
</tr>
<tr>
<td>24 03 00 00</td>
<td>methodIdsOff</td>
</tr>
<tr>
<td>02 00 00 00</td>
<td>classDefsSize</td>
</tr>
<tr>
<td>7c 04 00 00</td>
<td>classDefsOff</td>
</tr>
<tr>
<td>08 0c 00 00</td>
<td>dataSize</td>
</tr>
<tr>
<td>bc 04 00 00</td>
<td>dataOff</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="写程序解析_DexHeader">写程序解析 DexHeader</h2><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="atom">class</span> <span class="name">DexStruct</span>(<span class="atom">object</span>):</span><br><span class="line">    <span class="name">DexHeader</span> = &#123;</span><br><span class="line">          <span class="string">"magic"</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="string">"checkSum"</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="string">'signature'</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="string">'fileSize'</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="string">"headerSize"</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="string">"endianTag"</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="string">"linkSize"</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="string">"linkOff"</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="string">"mapOff"</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="string">"stringIdsSize"</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="string">"stringIdsOff"</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="string">"typeIdsSize"</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="string">"typeIdsOff"</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="string">"protoIdsSize"</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="string">"protoIdsOff"</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="string">"fieldIdsSize"</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="string">"fieldIdsOff"</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="string">"methodIdsSize"</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="string">"methodIdsOff"</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="string">"classDefsSize"</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="string">"classDefsOff"</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="string">"dataSize"</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="string">"dataOff"</span>: <span class="number">0</span>,   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="atom">def</span> <span class="atom">parseHeader</span>(<span class="atom">header_data</span>):</span><br><span class="line"></span><br><span class="line">        <span class="atom">header_list</span> = [<span class="atom">header_data</span>[<span class="atom">i</span>:<span class="atom">i</span>+<span class="number">4</span>] <span class="atom">for</span> <span class="atom">i</span> <span class="atom">in</span> <span class="atom">range</span>(<span class="number">32</span>,<span class="number">112</span>,<span class="number">4</span>)]</span><br><span class="line">        <span class="atom">header_list</span>.<span class="atom">insert</span>(<span class="number">0</span>,<span class="atom">header_data</span>[<span class="number">12</span>:<span class="number">32</span>])</span><br><span class="line">        <span class="atom">header_list</span>.<span class="atom">insert</span>(<span class="number">0</span>,<span class="atom">header_data</span>[<span class="number">8</span>:<span class="number">12</span>])</span><br><span class="line">        <span class="atom">header_list</span>.<span class="atom">insert</span>(<span class="number">0</span>,<span class="atom">header_data</span>[:<span class="number">8</span>])</span><br><span class="line"></span><br><span class="line">        <span class="name">DexStruct</span>.<span class="name">DexHeader</span>[<span class="string">'magic'</span>] = <span class="atom">struct</span>.<span class="atom">unpack</span>(<span class="string">'8s'</span>,<span class="atom">header_list</span>[<span class="number">0</span>])[<span class="number">0</span>]</span><br><span class="line">        <span class="atom">if</span> <span class="name">DexStruct</span>.<span class="name">DexHeader</span>[<span class="string">'magic'</span>] != <span class="string">"dex\n035\0"</span>:</span><br><span class="line">            <span class="atom">print</span> <span class="string">'invalid dex file.'</span></span><br><span class="line">            <span class="atom">exit</span>(-<span class="number">1</span>)</span><br><span class="line">        <span class="name">DexStruct</span>.<span class="name">DexHeader</span>[<span class="string">'checkSum'</span>] = <span class="atom">struct</span>.<span class="atom">unpack</span>(<span class="string">'I'</span>,<span class="atom">header_list</span>[<span class="number">1</span>])[<span class="number">0</span>]</span><br><span class="line">        <span class="name">DexStruct</span>.<span class="name">DexHeader</span>[<span class="string">'signature'</span>] = <span class="atom">struct</span>.<span class="atom">unpack</span>(<span class="string">'20s'</span>,<span class="atom">header_list</span>[<span class="number">2</span>])[<span class="number">0</span>]</span><br><span class="line">        <span class="name">DexStruct</span>.<span class="name">DexHeader</span>[<span class="string">'fileSize'</span>] = <span class="atom">struct</span>.<span class="atom">unpack</span>(<span class="string">'I'</span>,<span class="atom">header_list</span>[<span class="number">3</span>])[<span class="number">0</span>]</span><br><span class="line">        <span class="name">DexStruct</span>.<span class="name">DexHeader</span>[<span class="string">'headerSize'</span>] = <span class="atom">struct</span>.<span class="atom">unpack</span>(<span class="string">'I'</span>,<span class="atom">header_list</span>[<span class="number">4</span>])[<span class="number">0</span>]</span><br><span class="line">        <span class="name">DexStruct</span>.<span class="name">DexHeader</span>[<span class="string">'endianTag'</span>] = <span class="atom">struct</span>.<span class="atom">unpack</span>(<span class="string">'I'</span>,<span class="atom">header_list</span>[<span class="number">5</span>])[<span class="number">0</span>]</span><br><span class="line">        <span class="name">DexStruct</span>.<span class="name">DexHeader</span>[<span class="string">'linkSize'</span>] = <span class="atom">struct</span>.<span class="atom">unpack</span>(<span class="string">'I'</span>,<span class="atom">header_list</span>[<span class="number">6</span>])[<span class="number">0</span>]</span><br><span class="line">        <span class="name">DexStruct</span>.<span class="name">DexHeader</span>[<span class="string">'linkOff'</span>] = <span class="atom">struct</span>.<span class="atom">unpack</span>(<span class="string">'I'</span>,<span class="atom">header_list</span>[<span class="number">7</span>])[<span class="number">0</span>]</span><br><span class="line">        <span class="name">DexStruct</span>.<span class="name">DexHeader</span>[<span class="string">'mapOff'</span>] = <span class="atom">struct</span>.<span class="atom">unpack</span>(<span class="string">'I'</span>,<span class="atom">header_list</span>[<span class="number">8</span>])[<span class="number">0</span>]</span><br><span class="line">        <span class="name">DexStruct</span>.<span class="name">DexHeader</span>[<span class="string">'stringIdsSize'</span>] = <span class="atom">struct</span>.<span class="atom">unpack</span>(<span class="string">'I'</span>,<span class="atom">header_list</span>[<span class="number">9</span>])[<span class="number">0</span>]</span><br><span class="line">        <span class="name">DexStruct</span>.<span class="name">DexHeader</span>[<span class="string">'stringIdsOff'</span>] = <span class="atom">struct</span>.<span class="atom">unpack</span>(<span class="string">'I'</span>,<span class="atom">header_list</span>[<span class="number">10</span>])[<span class="number">0</span>]</span><br><span class="line">        <span class="name">DexStruct</span>.<span class="name">DexHeader</span>[<span class="string">'typeIdsSize'</span>] = <span class="atom">struct</span>.<span class="atom">unpack</span>(<span class="string">'I'</span>,<span class="atom">header_list</span>[<span class="number">11</span>])[<span class="number">0</span>]</span><br><span class="line">        <span class="name">DexStruct</span>.<span class="name">DexHeader</span>[<span class="string">'typeIdsOff'</span>] = <span class="atom">struct</span>.<span class="atom">unpack</span>(<span class="string">'I'</span>,<span class="atom">header_list</span>[<span class="number">12</span>])[<span class="number">0</span>]</span><br><span class="line">        <span class="name">DexStruct</span>.<span class="name">DexHeader</span>[<span class="string">'protoIdsSize'</span>] = <span class="atom">struct</span>.<span class="atom">unpack</span>(<span class="string">'I'</span>,<span class="atom">header_list</span>[<span class="number">13</span>])[<span class="number">0</span>]</span><br><span class="line">        <span class="name">DexStruct</span>.<span class="name">DexHeader</span>[<span class="string">'protoIdsOff'</span>] = <span class="atom">struct</span>.<span class="atom">unpack</span>(<span class="string">'I'</span>,<span class="atom">header_list</span>[<span class="number">14</span>])[<span class="number">0</span>]</span><br><span class="line">        <span class="name">DexStruct</span>.<span class="name">DexHeader</span>[<span class="string">'fieldIdsSize'</span>] = <span class="atom">struct</span>.<span class="atom">unpack</span>(<span class="string">'I'</span>,<span class="atom">header_list</span>[<span class="number">15</span>])[<span class="number">0</span>]</span><br><span class="line">        <span class="name">DexStruct</span>.<span class="name">DexHeader</span>[<span class="string">'fieldIdsOff'</span>] = <span class="atom">struct</span>.<span class="atom">unpack</span>(<span class="string">'I'</span>,<span class="atom">header_list</span>[<span class="number">16</span>])[<span class="number">0</span>]</span><br><span class="line">        <span class="name">DexStruct</span>.<span class="name">DexHeader</span>[<span class="string">'methodIdsSize'</span>] = <span class="atom">struct</span>.<span class="atom">unpack</span>(<span class="string">'I'</span>,<span class="atom">header_list</span>[<span class="number">17</span>])[<span class="number">0</span>]</span><br><span class="line">        <span class="name">DexStruct</span>.<span class="name">DexHeader</span>[<span class="string">'methodIdsOff'</span>] = <span class="atom">struct</span>.<span class="atom">unpack</span>(<span class="string">'I'</span>,<span class="atom">header_list</span>[<span class="number">18</span>])[<span class="number">0</span>]</span><br><span class="line">        <span class="name">DexStruct</span>.<span class="name">DexHeader</span>[<span class="string">'classDefsSize'</span>] = <span class="atom">struct</span>.<span class="atom">unpack</span>(<span class="string">'I'</span>,<span class="atom">header_list</span>[<span class="number">19</span>])[<span class="number">0</span>]</span><br><span class="line">        <span class="name">DexStruct</span>.<span class="name">DexHeader</span>[<span class="string">'classDefsOff'</span>] = <span class="atom">struct</span>.<span class="atom">unpack</span>(<span class="string">'I'</span>,<span class="atom">header_list</span>[<span class="number">20</span>])[<span class="number">0</span>]</span><br><span class="line">        <span class="name">DexStruct</span>.<span class="name">DexHeader</span>[<span class="string">'dataSize'</span>] = <span class="atom">struct</span>.<span class="atom">unpack</span>(<span class="string">'I'</span>,<span class="atom">header_list</span>[<span class="number">21</span>])[<span class="number">0</span>]</span><br><span class="line">        <span class="name">DexStruct</span>.<span class="name">DexHeader</span>[<span class="string">'dataOff'</span>] = <span class="atom">struct</span>.<span class="atom">unpack</span>(<span class="string">'I'</span>,<span class="atom">header_list</span>[<span class="number">22</span>])[<span class="number">0</span>]</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Reference">Reference</h2><p><a href="https://source.android.com/devices/tech/dalvik/dex-format.html" target="_blank" rel="external">Dalvik Executable format</a></p>
<p><a href="http://www.ituring.com.cn/book/1131" target="_blank" rel="external">《Android 软件安全与逆向分析》</a></p>
<p><a href="http://www.blogfshare.com/dex-format.html" target="_blank" rel="external">Android安全–Dex文件格式详解</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<p><img src="http://7xo976.com1.z0.glb.clouddn.com/images/github-io/Android/dex-file-general-structure-header.png" alt="header"></p>
<h2 id="dex_简介">dex 简介</h2><p>dex 文件是 dalvik 虚拟机的可执行文件。</p>]]>
    
    </summary>
    
      <category term="Android 安全" scheme="http://kiya-z.github.io/tags/Android-%E5%AE%89%E5%85%A8/"/>
    
      <category term="dex" scheme="http://kiya-z.github.io/tags/dex/"/>
    
      <category term="Android" scheme="http://kiya-z.github.io/categories/Android/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何运行 .smali 程序]]></title>
    <link href="http://kiya-z.github.io/2015/11/16/how-to-run-file-ended-with-smali/"/>
    <id>http://kiya-z.github.io/2015/11/16/how-to-run-file-ended-with-smali/</id>
    <published>2015-11-16T09:27:19.000Z</published>
    <updated>2015-11-16T09:29:57.017Z</updated>
    <content type="html"><![CDATA[<h2 id="准备_smali_程序">准备 smali 程序</h2><a id="more"></a>
<p>从 《Android 软件安全与逆向》书中抠出一段，起名为 <code>FirstSmali.smali</code> ：<br><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">.class</span><span class="keyword"> public</span> <span class="class">LFirstSmali;</span>  <span class="comment"># 定义类名</span></span><br><span class="line"><span class="keyword">.super</span> <span class="class">Ljava/lang/Object;</span>   <span class="comment"># 定义父类</span></span><br><span class="line"><span class="keyword">.method</span><span class="keyword"> public</span><span class="keyword"> static</span><span class="function"> main(</span><span class="keyword">[</span><span class="class">Ljava/lang/String;</span><span class="function">)</span>V     <span class="comment"># 声明静态方法</span></span><br><span class="line"><span class="keyword">    .registers</span> 4     <span class="comment"># 寄存器</span></span><br><span class="line">    <span class="comment">#.parameter      # 参数</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">    .prologue</span>      <span class="comment"># 代码起始</span></span><br><span class="line">   <span class="instruction"> nop</span><br><span class="line"></span>   <span class="instruction"> nop</span><br><span class="line"></span>   <span class="instruction"> nop</span><br><span class="line"></span>   <span class="instruction"> nop</span><br><span class="line"></span>    <span class="comment">#数据定义</span></span><br><span class="line">   <span class="instruction"> const/16 </span><span class="variable">v0</span>,0x8</span><br><span class="line">   <span class="instruction"> const/4 </span><span class="variable">v1</span>,0x5</span><br><span class="line">   <span class="instruction"> const/4 </span><span class="variable">v2</span>,0x3</span><br><span class="line">    <span class="comment">#数据操作</span></span><br><span class="line">   <span class="instruction"> move </span><span class="variable">v1</span>,<span class="variable">v2</span></span><br><span class="line">    <span class="comment">#数组操作</span></span><br><span class="line">   <span class="instruction"> new-array </span><span class="variable">v0</span>,<span class="variable">v0</span>,<span class="keyword">[</span>I</span><br><span class="line">   <span class="instruction"> array-length </span><span class="variable">v1</span>,<span class="variable">v0</span></span><br><span class="line">    <span class="comment">#实例操作</span></span><br><span class="line">   <span class="instruction"> new-instance </span><span class="variable">v1</span>,<span class="class">Ljava/lang/StringBuilder;</span></span><br><span class="line">    <span class="comment">#方法调用</span></span><br><span class="line">   <span class="instruction"> invoke-direct </span>&#123;<span class="variable">v1</span>&#125;,<span class="class">Ljava/lang/StringBuilder;</span><span class="function">-&gt;&lt;init&gt;(</span><span class="function">)</span>V</span><br><span class="line">    <span class="comment">#跳转</span></span><br><span class="line">   <span class="instruction"> if-nez </span><span class="variable">v0</span>,<span class="keyword"> :cond_0</span></span><br><span class="line">   <span class="instruction"> goto </span>:goto_0</span><br><span class="line">   <span class="keyword"> :cond_0</span></span><br><span class="line">    <span class="comment">#数据转换</span></span><br><span class="line">   <span class="instruction"> int-to-float </span><span class="variable">v2</span>,<span class="variable">v2</span></span><br><span class="line">    <span class="comment">#运算</span></span><br><span class="line">   <span class="instruction"> add-float </span><span class="variable">v2</span>,<span class="variable">v2</span>,<span class="variable">v2</span></span><br><span class="line">    <span class="comment">#比较</span></span><br><span class="line">   <span class="instruction"> cmpl-float </span><span class="variable">v0</span>,<span class="variable">v2</span>,<span class="variable">v2</span></span><br><span class="line">    <span class="comment">#字段操作</span></span><br><span class="line">   <span class="instruction"> sget-object </span><span class="variable">v0</span>,<span class="class">Ljava/lang/System;</span>-&gt;out:<span class="class">Ljava/io/PrintStream;</span></span><br><span class="line">   <span class="instruction"> const-string </span><span class="variable">v1</span>,<span class="string">"Hello Smali"</span></span><br><span class="line">    <span class="comment">#调用</span></span><br><span class="line">   <span class="instruction"> invoke-virtual </span>&#123;<span class="variable">v0</span>,<span class="variable">v1</span>&#125;, <span class="class">Ljava/io/PrintStream;</span><span class="function">-&gt;println(</span><span class="class">Ljava/lang/String;</span><span class="function">)</span>V</span><br><span class="line">    <span class="comment">#返回</span></span><br><span class="line">   <span class="keyword"> :goto_0</span></span><br><span class="line">   <span class="instruction"> return-void</span><br><span class="line"></span>   <span class="instruction"> return-void </span>    <span class="comment"># 返回空</span><span class="keyword"></span><br><span class="line"></span><br><span class="line">.end method</span></span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="编译_smali_程序">编译 smali 程序</h2><p>将 <code>.smali</code> 文件编译为 <code>.dex</code> 文件 :<br><code>java -jar smali.jar -o FirstSmali.dex FirstSmali.smali</code></p>
<hr>
<h2 id="执行_smali_程序">执行 smali 程序</h2><p>打开 <code>adb</code> 环境，连上手机，在命令行下<br>执行 <code>adb devices</code> 查看手机是否连接成功；<br>执行 <code>adb push FirstSmali.dex /sdcard/</code> 将 dex 文件推到手机上；<br>执行如下命令就 OK 了。<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell dalvikvm -cp /sdcard/FirstSmali<span class="class">.dex</span> FirstSmali</span><br></pre></td></tr></table></figure></p>
<h3 id="备注">备注</h3><p><code>-cp</code> 是 <code>classpath</code>  的意思，<code>dalvikvm</code> 命令第一个参数指定类路径，第二个指定类名。</p>
<p>另外，如果想要 push 到如 <code>data/local</code> 之类的目录下是没有权限的，可以先 push 到 sdcard，进入 <code>adb shell</code> 执行 <code>su</code> 获得 root 权限之后，就可以复制到 <code>data</code> 目录了。</p>
<p>本文程序只有一个 dex 文件，多个的话需要打包为 <code>zip</code> ，将此 zip 文件作为 <code>dalvikvm</code> 的第一个参数便可。</p>
]]></content>
    <summary type="html">
    <![CDATA[<h2 id="准备_smali_程序">准备 smali 程序</h2>]]>
    
    </summary>
    
      <category term="Android 安全" scheme="http://kiya-z.github.io/tags/Android-%E5%AE%89%E5%85%A8/"/>
    
      <category term="smali" scheme="http://kiya-z.github.io/tags/smali/"/>
    
      <category term="反编译" scheme="http://kiya-z.github.io/tags/%E5%8F%8D%E7%BC%96%E8%AF%91/"/>
    
      <category term="Android" scheme="http://kiya-z.github.io/categories/Android/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[校验数字签名防止 apk 被二次打包 - Java层校验（大众点评为例）]]></title>
    <link href="http://kiya-z.github.io/2015/11/12/check-signature-for-avoiding-fake-app-java-level-check/"/>
    <id>http://kiya-z.github.io/2015/11/12/check-signature-for-avoiding-fake-app-java-level-check/</id>
    <published>2015-11-12T09:36:23.000Z</published>
    <updated>2015-11-13T06:30:44.322Z</updated>
    <content type="html"><![CDATA[<blockquote>
<p>测试环境<br>Ubuntu 14.04<br>Lenovo Android 5.1<br>Lenovo Android 4.2.2<br>Android Studio</p>
</blockquote>
<a id="more"></a>
<h2 id="普及签名包名知识">普及签名包名知识</h2><p>包名 (Package Name) 相当于「应用的身份证」，是系统用来<strong>区分不同应用</strong>的字段，重复的包名会被认为是同一款应用。<br>签名文件相当于「开发者的身份证」，目的是为了<strong>检验应用是否被人更改过</strong>（应用必须签名过才能正常安装）。</p>
<p>包名相同签名相同时，会发生 替换安装 / 应用升级；<br>包名相同签名不同时，安装失败；<br>包名不同签名相同时，相当于同一开发者的两个应用，互相不冲突。</p>
<blockquote>
<p>签名的注意事项<br>所有的Android应用都必须有数字签名，没有不存在数字签名的应用，包括模拟器上运行的。Android系统不会安装没有数字证书的应用。<br>签名的数字证书不需要权威机构来认证，是开发者自己产生的数字证书，即所谓的自签名。<br>正式发布一个Android应用时，必须使用一个合适的私钥生成的数字证书来给程序签名，不能使用ADT插件或者ANT工具生成的调试证书来发布。<br>Android将数字证书用来标识应用程序的作者和在应用程序之间建立信任关系，而不是用来决定最终用户可以安装哪些应用程序。</p>
</blockquote>
<hr>
<h2 id="为大众点评换签名">为大众点评换签名</h2><p>按照常规步骤使用 <code>apktool</code> + <code>signapk</code> 反编译、编译、签名并安装到手机上（没有修改任何代码），打开 app 选择城市后界面如下图并很快退出：</p>
<p><img src="http://7xo976.com1.z0.glb.clouddn.com/images/github-io/Android/dianping-crash.jpeg-style1" alt="dianping-crash"></p>
<p>说明点评对签名进行了校验 。</p>
<hr>
<h2 id="分析校验方法">分析校验方法</h2><h3 id="怎么退出的？">怎么退出的？</h3><p>打开 apktool 反编译得到的文件夹下的 <code>AndroidManifest.xml</code> ，得到程序包名：<code>com.dianping.v1</code> 。<br>清除大众点评的数据，打开 as，连上手机，log 的过滤条件设为 com.dianping ，在选择城市之前清一下 log ，在 log 里搜索 “die”，比较明显的是有四处：</p>
<p>进程死亡：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Process com<span class="class">.dianping</span><span class="class">.v1</span> (pid <span class="number">19182</span>) has died</span><br><span class="line">Process com<span class="class">.dianping</span><span class="class">.v1</span> (pid <span class="number">19586</span>) has died</span><br><span class="line">Process com<span class="class">.dianping</span><span class="class">.v1</span> (pid <span class="number">19650</span>) has died</span><br></pre></td></tr></table></figure></p>
<p>app 死亡：<br><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Force removing ActivityRecord&#123;<span class="number">266</span>e5efd u0 com.dianping.v1/.NovaMainActivity t14010&#125;: app died, no saved <span class="keyword">state</span></span><br></pre></td></tr></table></figure></p>
<p>其中前两个进程死亡之后都有开启进程的操作，说明第一次校验失败后重试了两次：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">startProcess:</span> name=com.dianping.v1 app=<span class="literal">null</span> knownToBeDead=<span class="literal">true</span> thread=<span class="literal">null</span> pid=-<span class="number">1</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">startProcess:</span> name=com.dianping.v1 app=<span class="literal">null</span> knownToBeDead=<span class="literal">true</span> thread=<span class="literal">null</span> pid=-<span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>最后一个直接杀死了 app，没有再继续创建进程。</p>
<p>在进程结束之前，发生错误的调用记录：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">9586</span>-<span class="number">19586</span>/? D/AccessibilityManager:     at com.dianping.base.app.NovaActivity.setContentView(NovaActivity.java:<span class="number">722</span>)</span><br><span class="line"> <span class="number">9586</span>-<span class="number">19586</span>/? D/AccessibilityManager:     at com.dianping.main.guide.MainActivity.setOnContentView(MainActivity.java:<span class="number">339</span>)</span><br><span class="line"> <span class="number">9586</span>-<span class="number">19586</span>/? D/AccessibilityManager:     at com.dianping.base.basic.FragmentTabActivity.onCreate(FragmentTabActivity.java:<span class="number">51</span>)</span><br><span class="line"> <span class="number">9586</span>-<span class="number">19586</span>/? D/AccessibilityManager:     at com.dianping.base.widget.NovaFragmentTabActivity.onCreate(NovaFragmentTabActivity.java:<span class="number">26</span>)</span><br><span class="line"> <span class="number">9586</span>-<span class="number">19586</span>/? D/AccessibilityManager:     at com.dianping.main.guide.MainActivity.onCreate(MainActivity.java:<span class="number">169</span>)</span><br><span class="line"> <span class="number">9586</span>-<span class="number">19586</span>/? D/AccessibilityManager:     at com.dianping.v1.NovaMainActivity.onCreate(NovaMainActivity.java:<span class="number">15</span>)</span><br></pre></td></tr></table></figure></p>
<h3 id="代码探索">代码探索</h3><p>解压 apk 文件，发现有 3 个 dex 文件，先拿第一个下手，JD-GUI 打开发现代码没有混淆！</p>
<p>调用记录中的文件从上往下过一遍，发现在 <code>com.dianping.main.guide.MainActivity.onCreate()</code> 方法中有校验签名的函数：<br><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="comment">(!checkSignature()</span>) &#123;    </span><br><span class="line">      Process.killProcess<span class="comment">(Process.myPid()</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p><code>checkSignature</code> 函数：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> boolean <span class="title">checkSignature</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line"> <span class="keyword">try</span></span><br><span class="line"> &#123;</span><br><span class="line">   Signature[] arrayOfSignature = getPackageManager().getPackageInfo(getPackageName(), <span class="number">64</span>).signatures;     <span class="comment">//获得签名数组</span></span><br><span class="line">   <span class="keyword">if</span> (arrayOfSignature != null)</span><br><span class="line">   &#123;</span><br><span class="line">     <span class="keyword">if</span> (arrayOfSignature.length == <span class="number">0</span>) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">int</span> j = arrayOfSignature.length;</span><br><span class="line">     <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">     <span class="keyword">while</span> (i &lt; j)   <span class="comment">//如果数组中的某个元素值与 'ac6fc3fe' 相等，返回校验成功；如果直到结束也没有相等的元素，返回失败</span></span><br><span class="line">     &#123;               <span class="comment">//只比较一个特定的元素，可能也是为了不把整个签名泄露出来，同时也做到了一定程度的校验</span></span><br><span class="line">       String str = Integer.toHexString(arrayOfSignature[i].toCharsString().hashCode());</span><br><span class="line">       <span class="keyword">if</span> (!<span class="string">"ac6fc3fe"</span>.equalsIgnoreCase(str))   </span><br><span class="line">       &#123;</span><br><span class="line">         boolean <span class="keyword">bool</span> = <span class="string">"600cf559"</span>.equalsIgnoreCase(str);       <span class="comment">//这个比较好像没用</span></span><br><span class="line">         <span class="keyword">if</span> (!<span class="keyword">bool</span>) &#123;&#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">else</span></span><br><span class="line">       &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       i += <span class="number">1</span>;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">catch</span> (Exception localException) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>相关 API：</p>
<p><code>public Signature[] signatures</code><br>Array of all signatures read from the package file. This is only filled in if the flag GET_SIGNATURES was set.</p>
<p><code>public static final int GET_SIGNATURES</code><br>PackageInfo flag: return information about the signatures included in the package.<br>Constant Value: 64 (0x00000040)</p>
<p><code>public boolean equalsIgnoreCase (String string)</code><br>Compares the given string to this string ignoring case.<br>The strings are compared one char at a time.</p>
<h3 id="流程修改">流程修改</h3><p>在 <code>smali/com/dianping/main/guide/MainActivity.smali</code> 中搜索 <code>ac6fc3fe</code> :<br><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">.line</span> 358</span><br><span class="line"><span class="keyword">    .local</span> <span class="variable">v4</span>, <span class="string">"myHash"</span>:<span class="class">Ljava/lang/String;</span></span><br><span class="line">   <span class="instruction"> const-string </span><span class="variable">v9</span>, <span class="string">"ac6fc3fe"</span></span><br><span class="line"></span><br><span class="line">   <span class="instruction"> invoke-virtual </span>&#123;<span class="variable">v9</span>, <span class="variable">v4</span>&#125;, <span class="class">Ljava/lang/String;</span><span class="function">-&gt;equalsIgnoreCase(</span><span class="class">Ljava/lang/String;</span><span class="function">)</span>Z</span><br><span class="line"></span><br><span class="line">   <span class="instruction"> move-result </span><span class="variable">v9</span></span><br><span class="line"></span><br><span class="line">   <span class="instruction"> if-nez </span><span class="variable">v9</span>,<span class="keyword"> :cond_2</span>     <span class="function"> //if(</span>!equal(..<span class="function">)</span><span class="function">)</span><span class="instruction"> return </span>1</span><br></pre></td></tr></table></figure></p>
<p>找到 <code>con_2</code> 的定义:<br><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">.line</span> 359<span class="keyword"></span><br><span class="line">:cond_2</span><span class="instruction"></span><br><span class="line">const/4 </span><span class="variable">v8</span>, 0x1</span><br><span class="line"><span class="instruction"></span><br><span class="line">goto </span>:goto_0</span><br></pre></td></tr></table></figure></p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">:goto_0</span></span><br><span class="line">    <span class="keyword">return</span> v8</span><br></pre></td></tr></table></figure>
<p>所以把 <code>if-nez v9, :cond_2</code> 改成 <code>if-eqz v9, :cond_2</code> 就可以了，当然，修改方法还有很多。</p>
<h3 id="打包签名">打包签名</h3><p>点评可以正常打开，正常登录，正常使用了。</p>
<hr>
<blockquote>
<p>番外：<br>而另一台手机 (Lenovo Android 4.2.2) 测试进程会不断重新创建。<br>应用 crash 之后 App 对应的 Process 都被杀死，然后安排重启 Service，重新启动 Task 栈顶的 Activity 。</p>
</blockquote>
<hr>
<h2 id="Reference">Reference</h2><p><a href="http://www.ituring.com.cn/book/1131" target="_blank" rel="external">Android软件安全与逆向分析</a><br><a href="http://www.wandoujia.com/blog/xibaibai-diary-3" target="_blank" rel="external">洗白白手记：绕开 Android 应用开发的那些「坑」</a><br><a href="http://www.oschina.net/question/163910_27292#tags_nav" target="_blank" rel="external">给 Android 应用程序签名</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<blockquote>
<p>测试环境<br>Ubuntu 14.04<br>Lenovo Android 5.1<br>Lenovo Android 4.2.2<br>Android Studio</p>
</blockquote>]]>
    
    </summary>
    
      <category term="Android 安全" scheme="http://kiya-z.github.io/tags/Android-%E5%AE%89%E5%85%A8/"/>
    
      <category term="反编译" scheme="http://kiya-z.github.io/tags/%E5%8F%8D%E7%BC%96%E8%AF%91/"/>
    
      <category term="Android" scheme="http://kiya-z.github.io/categories/Android/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Android 安全工具包（持续更新）]]></title>
    <link href="http://kiya-z.github.io/2015/11/12/Android-security-tools/"/>
    <id>http://kiya-z.github.io/2015/11/12/Android-security-tools/</id>
    <published>2015-11-12T08:09:27.000Z</published>
    <updated>2015-11-16T09:55:31.861Z</updated>
    <content type="html"><![CDATA[<blockquote>
<p><strong>工具清单</strong></p>
<ul>
<li>Apktool</li>
<li>smali &amp; baksmali</li>
<li>dex2jar</li>
<li>JD-GUI</li>
<li>signapk</li>
<li>dx &amp; ddx</li>
</ul>
</blockquote>
<p>以上工具可点击 <a href="https://github.com/kiya-z/Android/tree/master/tools" target="_blank" rel="external">这里</a> 打包下载</p>
<p><strong>本文环境：<code>Ubuntu 14.04.3 LTS 64-bit</code></strong></p>
<a id="more"></a>
<hr>
<h3 id="工具使用场景：">工具使用场景：</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java-&#62;class: javac&#10;smali-&#62;dex: smali.jar&#10;class-&#62;dex: dx&#10;dex-&#62;arm: execute&#10;&#10;dex-&#62;smali: baksmali&#10;dex-&#62;class: dex2jar&#10;class-&#62;java: JD-GUI</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="Apktool"><strong>Apktool</strong></h1><p>点击 <a href="http://ibotpeaches.github.io/Apktool/install/" target="_blank" rel="external">官网</a> 下载，里面也有详细的安装步骤。</p>
<h3 id="中文步骤及注意事项">中文步骤及注意事项</h3><p>（<em>此处为 Apktool 2.x 版本</em>）</p>
<ol>
<li>右键另存 <a href="https://raw.githubusercontent.com/iBotPeaches/Apktool/master/scripts/linux/apktool" target="_blank" rel="external">脚本文件</a>，名为 <code>apktool</code> 。如果不能另存，打开 <a href="https://raw.githubusercontent.com/iBotPeaches/Apktool/master/scripts/linux/apktool" target="_blank" rel="external">脚本文件</a>， 复制全部内容到新建文件 <code>apktool</code> 中；</li>
<li>下载 <a href="https://bitbucket.org/iBotPeaches/apktool/downloads" target="_blank" rel="external">apktool</a>，将其重命名为 <code>apktool.jar</code> 。</li>
<li>如果是系统是 64 位，需要安装 32 位的库文件。如何安装可参考 <a href="http://stackoverflow.com/questions/23182765/how-to-install-ia32-libs-in-ubuntu-14-04-lts-trusty-tahr" target="_blank" rel="external">How to install ia32-libs in Ubuntu 14.04 LTS (Trusty Tahr)</a> . 或者直接执行以下命令：<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo -<span class="tag">i</span></span><br><span class="line">cd /etc/apt/sources<span class="class">.list</span><span class="class">.d</span></span><br><span class="line">echo <span class="string">"deb http://old-releases.ubuntu.com/ubuntu/ raring main restricted universe multiverse"</span> &gt;ia32-libs-raring<span class="class">.list</span></span><br><span class="line">apt-get update</span><br><span class="line">apt-get install ia32-libs</span><br><span class="line">rm ia32-libs-raring<span class="class">.list</span> /etc/apt/sources<span class="class">.list</span><span class="class">.d</span></span><br><span class="line">apt-get update</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>执行完成可按 <code>Ctrl+D</code> 注销 root .</p>
<ol>
<li>把 <code>apktool</code> 和 <code>apktool.jar</code> 两个文件移动到 <code>usr/local/bin</code> . 此步骤需要 <code>sudo</code> .</li>
<li>为这两个文件加上可执行权限。</li>
<li>执行 <code>apktool</code> 测试效果。如果提示 <code>can&#39;t find file apktool.jar</code> ，可能是因为当前用户没有 <code>apktool.jar</code> 的读权限，试试用 <code>sudo apktool</code> 或者为其加上读权限。</li>
</ol>
<hr>
<h1 id="smali_&amp;_baksmali"><strong>smali &amp; baksmali</strong></h1><p>Apktool 中内置了 smali 和 baksmali，但我还是手痒痒的点击了 <a href="https://bitbucket.org/JesusFreke/smali/downloads" target="_blank" rel="external">下载</a> ，Aha ! 万一哪天用到了捏 ..</p>
<hr>
<h1 id="dex2jar"><strong>dex2jar</strong></h1><p>下载 <a href="https://bitbucket.org/pxb1988/dex2jar/downloads" target="_blank" rel="external">dex2jar</a> 解压，你可以选择为所有的 <code>.sh</code> 文件加上执行权限，目前我只加了 <code>d2j-dex2jar.sh</code> 和 <code>d2j_invoke.sh</code> 。如果报错找不到命令，就是因为你没有加执行权限。</p>
<hr>
<h1 id="JD-GUI"><strong>JD-GUI</strong></h1><p>去 <a href="http://jd.benow.ca/" target="_blank" rel="external">官网</a> 下载相应版本。<br>我下载的是 <code>.deb</code> 文件，安装命令为 <code>sudo dpkg -i filename</code> .</p>
<hr>
<h1 id="signapk"><strong>signapk</strong></h1><p>进行签名需要 <code>sianapk.sh</code> 、<code>signapk.jar</code> 和两个签名文件 <code>testkey.pk8</code> 、<code>testkey.x509.pem</code> 。<br><a href="https://github.com/kiya-z/Android/tree/master/tools/signapk" target="_blank" rel="external">点击下载</a></p>
<hr>
<h1 id="dx_&amp;_ddx"><strong>dx &amp; ddx</strong></h1><p><code>dx</code> 是整个编译过程的一部分，将 Java 字节码转换为 Dalvik 字节码（class 文件变成 dex 文件），<code>ddx</code> 则正好相反。<br>你可以在 SDK 中找到它们，或者 <a href="https://github.com/kiya-z/Android/tree/master/tools" target="_blank" rel="external">下载</a> 。</p>
<hr>
<blockquote>
<p>to be continued.</p>
</blockquote>
]]></content>
    <summary type="html">
    <![CDATA[<blockquote>
<p><strong>工具清单</strong></p>
<ul>
<li>Apktool</li>
<li>smali &amp; baksmali</li>
<li>dex2jar</li>
<li>JD-GUI</li>
<li>signapk</li>
<li>dx &amp; ddx</li>
</ul>
</blockquote>
<p>以上工具可点击 <a href="https://github.com/kiya-z/Android/tree/master/tools">这里</a> 打包下载</p>
<p><strong>本文环境：<code>Ubuntu 14.04.3 LTS 64-bit</code></strong></p>]]>
    
    </summary>
    
      <category term="Android 安全" scheme="http://kiya-z.github.io/tags/Android-%E5%AE%89%E5%85%A8/"/>
    
      <category term="反编译" scheme="http://kiya-z.github.io/tags/%E5%8F%8D%E7%BC%96%E8%AF%91/"/>
    
      <category term="工具" scheme="http://kiya-z.github.io/tags/%E5%B7%A5%E5%85%B7/"/>
    
      <category term="Android" scheme="http://kiya-z.github.io/categories/Android/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Python 之 接口和多态引发的血案]]></title>
    <link href="http://kiya-z.github.io/2015/11/11/Python-a-murder-about-interface-and-polymorphism/"/>
    <id>http://kiya-z.github.io/2015/11/11/Python-a-murder-about-interface-and-polymorphism/</id>
    <published>2015-11-11T07:52:39.000Z</published>
    <updated>2015-11-11T08:23:28.367Z</updated>
    <content type="html"><![CDATA[<h1 id="事故发生地">事故发生地</h1><p>在学习<a href="http://www.maiziedu.com/course/python/545-7480/" target="_blank" rel="external"> Python 面向对象视频 之 鸭子类型与多态 </a>时看到这样两句话不得其解：</p>
<blockquote>
<p>非动态语言必须通过继承和接口实现多态<br>动态语言不需要实现接口</p>
</blockquote>
<a id="more"></a>
<hr>
<h1 id="菜鸟的问题">菜鸟的问题</h1><p>(非动态语言以 Java 为例，动态语言以 Python 为例)</p>
<ol>
<li>接口和多态是什么关系？</li>
<li>Python 为什么没有接口？没有接口怎么实现接口对应的设计模式</li>
<li>Python 为什么没有重载？</li>
<li>Python 的多态是什么样的？</li>
</ol>
<hr>
<h2 id="接口和多态是什么关系？">接口和多态是什么关系？</h2><p>  在我的理解中，多态具有两种形式，重载和重写：</p>
<blockquote>
<p><strong>重载</strong>：<em>在同一个类中</em>，相同的方法名对应着不同的方法实现，其区别在于他们需要的参数和返回值不同。<br><strong>重写</strong>：<em>用于父类和子类间</em>，子类重写父类的方法，只是对应的方法实现不同，其方法名和参数都相同。</p>
</blockquote>
<p>这样看来，重写是基于继承的。那么接口呢？好像除了强制要求子类实现某些方法，我不知道还有什么别的作用。<br>正因如此，接口只是一个规范。在多个类都实现一个接口的时候他的作用就体现出来了，我们不需要知道在某个类中这个方法的具体实现，只需要这个类中有这个方法而我们可以直接调用就可以了。有了这样一个统一的标准，我们就不必担心同样功能的方法被起了各种各样的名字了。<br>所以，我觉得可以用这么一句话回答这个问题，<strong>接口不是实现多态的，而是基于多态的，有了多态接口才能发挥作用</strong>。</p>
<hr>
<h2 id="Python_为什么没有接口？没有接口怎么实现接口对应的设计模式">Python 为什么没有接口？没有接口怎么实现接口对应的设计模式</h2><p>接口的作用就是规范，规范参数类型，返回值等等，从而使相同的调用能够实现不同的效果；并且接口也是为了用来弥补语言自己表达能力的不足，如：Java 只支持单继承，为了使类拥有更多的特性，使用了多实现来弥补。静态的语言必须全部都规定好才能正确使用。<br>而在 Python  中，变量是没有类型的，不需要事先规定，不管调用者传入什么类型的对象，被调用者就会认为那就是我所需要的对象(鸭子类型)，如果在运行时传入的对象不具备需要的属性或方法，程序会直接报错。需要实现这个方法的话，就照实现就是了，返回和形参不限制类型，比如：在创建了类的实例后，动态地给该实例加上一个函数属性。这就是动态类型的优势。<br>这种风格被称为“<strong>鸭子类型</strong>”：</p>
<blockquote>
<p>在这种风格中，一个对象有效的语义，不是由继承自特定的类或实现特定的接口，而是由”当前方法和属性的集合”决定。<br>在我想成为鸭子的时候，不是我必须真的是个鸭子，而是我的行为表现的像是个鸭子，那我就是个鸭子</p>
</blockquote>
<p>相关概念 - “<strong>鸭子测试</strong>”：</p>
<blockquote>
<p>“当看到一只鸟走起来像鸭子、游泳起来像鸭子、叫起来也像鸭子，那么这只鸟就可以被称为鸭子。”<br>“换言之，不要检查它是不是一个鸭子：检查它像不像一个鸭子地叫，等等。取决于你需要哪个像鸭子的行为的子集来使用语言。”</p>
</blockquote>
<hr>
<h2 id="Python_为什么没有重载？">Python 为什么没有重载？</h2><blockquote>
<p>函数重载主要是为了解决两个问题：</p>
<ol>
<li>可变参数类型。</li>
<li>可变参数个数。</li>
</ol>
</blockquote>
<p>另外，一个基本的设计原则是，仅仅当两个函数除了参数类型和参数个数不同以外，其功能是完全相同的，此时才使用函数重载，如果两个函数的功能其实不同，那么不应当使用重载，而应当使用一个名字不同的函数。<br><em>对于情况 1</em>，函数功能相同，但是参数类型不同，Python 如何处理？答案是根本不需要处理，因为 python 可以接受任何类型的参数，如果函数的功能相同，那么不同的参数类型在 Python 中很可能是相同的代码，没有必要做成两个不同函数。<br><em>对于情况 2</em> ，函数功能相同，但参数个数不同，Python 如何处理？大家知道，答案就是缺省参数。对那些缺少的参数设定为缺省参数即可解决问题。因为你假设函数功能相同，那么那些缺少的参数终归是需要用的。<br>好了，鉴于情况 1 跟 情况 2 都有了解决方案，Python 自然就不需要函数重载了。</p>
<hr>
<h2 id="Python_的多态是什么样的？">Python 的多态是什么样的？</h2><p>多态即多种形态，在运行时确定其状态，在编译阶段无法确定其类型，这就是多态。<br>1）Python是解释性语言。不进行预编译，因此它就只在运行时确定其状态；<br>2）Python中变量是弱类型的。在定义时不用指明其类型，它会根据需要在运行时确定变量的类型。</p>
<hr>
<blockquote>
<p>结语：一些粗浅之语，有长进再补充。</p>
</blockquote>
<hr>
<h1 id="Reference：">Reference：</h1><p><a href="http://www.zhihu.com/question/20111251" target="_blank" rel="external"> Java 中的接口有什么作用？</a><br><a href="http://www.zhihu.com/question/20685467" target="_blank" rel="external"> Python 里没有接口，如何写设计模式？</a><br><a href="http://www.zhihu.com/question/20053359" target="_blank" rel="external">为什么 Python  不支持函数重载？</a><br><a href="http://www.cnblogs.com/dolphin0520/archive/2013/04/03/2997499.html" target="_blank" rel="external"> Python面向对象编程(二)</a><br><a href="https://zh.wikipedia.org/wiki/%E9%B8%AD%E5%AD%90%E7%B1%BB%E5%9E%8B" target="_blank" rel="external">鸭子类型</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<h1 id="事故发生地">事故发生地</h1><p>在学习<a href="http://www.maiziedu.com/course/python/545-7480/"> Python 面向对象视频 之 鸭子类型与多态 </a>时看到这样两句话不得其解：</p>
<blockquote>
<p>非动态语言必须通过继承和接口实现多态<br>动态语言不需要实现接口</p>
</blockquote>]]>
    
    </summary>
    
      <category term="Python" scheme="http://kiya-z.github.io/tags/Python/"/>
    
      <category term="Python" scheme="http://kiya-z.github.io/categories/Python/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[使用 Github Pages + Hexo + 多说 搭建博客全过程 - 基础篇]]></title>
    <link href="http://kiya-z.github.io/2015/11/10/use-Github-Pages-Hexo-duoshuo-to-set-up-a-blog-basic-steps/"/>
    <id>http://kiya-z.github.io/2015/11/10/use-Github-Pages-Hexo-duoshuo-to-set-up-a-blog-basic-steps/</id>
    <published>2015-11-10T03:27:33.000Z</published>
    <updated>2015-11-10T10:09:04.030Z</updated>
    <content type="html"><![CDATA[<p>看了很多博客，最后发现官方文档才是最可靠的！谨记！<br>本文只是自己尝试过程的记录，并非全部搭建方法。<br>&lt; 假设 git 已安装，Github 已注册 &gt;</p>
<blockquote>
<p>搭建环境：<br>os: Ubuntu 14.04.3 LTS<br>node: 4.2.2<br>hexo: 3.1.1<br>hexo theme: NexT<br>git: 1.9.1</p>
</blockquote>
<a id="more"></a>
<hr>
<h2 id="Step_1_安装_Node-js">Step 1 安装 Node.js</h2><ul>
<li>从<a href="https://nodejs.org/en/download/" target="_blank" rel="external">官网</a>下载系统对应的源码</li>
<li>依次执行以下命令解压编译安装<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar -xzvf <span class="keyword">node</span><span class="identifier"></span><span class="title">-v4</span>.<span class="number">2.2</span>.tar.gz</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="Step_2_安装_Hexo">Step 2 安装 Hexo</h2><ul>
<li>执行以下命令<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="operator"><span class="keyword">install</span> -<span class="keyword">g</span> hexo</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="Step_3_搭建本地博客">Step 3 搭建本地博客</h2><ul>
<li><p>初始化一枚目录存放博客, 进入</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="label">hexo</span> init <span class="keyword">blog</span><br><span class="line"></span><span class="label">cd</span> <span class="keyword">blog</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>执行</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="keyword">install</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>此时一个默认主题默认配置的 Hexo 博客就搭建完成了</p>
<ul>
<li><p>安装 Hexo 关于启动服务器的插件</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="operator"><span class="keyword">install</span> hexo-<span class="keyword">server</span> <span class="comment">--save</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动服务器, 本地查看效果, 如果不指定端口，默认为4000</p>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo <span class="keyword">server</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>打开 <a href="http://localhost:4000" target="_blank" rel="external">http://localhost:4000</a> 查看效果</p>
</li>
<li>使用 <strong>Ctrl+c</strong> 停止服务</li>
</ul>
<hr>
<h2 id="Step_4_主题和配置">Step 4 主题和配置</h2><p>在 <a href="https://hexo.io/themes/" target="_blank" rel="external">https://hexo.io/themes/</a> 选择某个喜欢的主题，以 NexT 为例，假设当前目录为 “blog”。</p>
<ul>
<li>前往<a href="https://github.com/iissnan/hexo-theme-next/releases" target="_blank" rel="external">NexT主题发布页面</a>下载主题的压缩包<br>(这是 Next 的稳定版本，我试用了最新版本，有一些问题故转为稳定版本)</li>
<li>解压并将目录更名为next</li>
<li>将 next 移动至 <strong>blog/themes/</strong> 目录下</li>
<li>将 blog 目录下的 <strong>_config.yml</strong> 文件中的 theme 属性值改为 next</li>
<li>此时主题更换成功，可启动 server 验证效果</li>
<li>对于 _config.yml 中的其他属性可根据情况自行修改，基本的有<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">title</span>: <span class="string">网站大标题</span></span><br><span class="line"><span class="attribute">subtitle</span>: <span class="string">网站小标题</span></span><br><span class="line"><span class="attribute">description</span>: <span class="string">你对于自己的描述</span></span><br><span class="line"><span class="attribute">author</span>: <span class="string">昵称</span></span><br><span class="line"><span class="attribute">avatar</span>: <span class="string">头像 (如:/images/avatar.jpg, images目录位于source目录下)</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="Step_5_Github_的操作">Step 5 Github 的操作</h2><ul>
<li>新建仓库名为 <strong>github用户名.github.io</strong><br>进入仓库，点击右侧 settings，在 Github Pages 标签下可看到  <em>Your site is published at <a href="http://你的用户名.github.io" target="_blank" rel="external">http://你的用户名.github.io</a>.</em> 这句话。 这时便可直接访问，如我的就是 <a href="http://kiya-z.github.io">kiya-z.github.io</a>.</li>
</ul>
<hr>
<h2 id="Step_6_将博客部署到Github">Step 6 将博客部署到Github</h2><ul>
<li><p>安装 hexo 关于 git 的组件</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="operator"><span class="keyword">install</span> hexo-deployer-git <span class="comment">--save</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在_config.yml 中为 git 添加配置</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">deploy</span>:</span><br><span class="line">    <span class="attribute">type</span>: git</span><br><span class="line">    <span class="attribute">repository</span>: 你的仓库地址(<span class="attribute">https</span>:<span class="comment">//github.com/用户名/用户名.github.io.git)</span></span><br><span class="line">    <span class="attribute">branch</span>: master</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行(每次修改都要执行这些命令才能在github pages看到效果)</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">hexo</span> generate</span><br><span class="line">hexo deploy</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>输入 github 的用户名和密码，部署完成之后访问你的如 <a href="http://kiya-z.github.io">kiya-z.github.io</a> 的网址即可看到和本地一样的效果。</p>
<hr>
<h2 id="Step_7_关于写博客">Step 7 关于写博客</h2><ul>
<li><p>新建博客</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo <span class="keyword">new</span> <span class="string">"文章名"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>使用编辑器写好文章后执行生成+部署(那两个～)</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">hexo</span> generate</span><br><span class="line">hexo deploy</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除文章<br>直接删掉 <em>source/_post</em> 下对应文章的文件，然后重新生成+部署即可。有时可能要多刷新几次才能看到效果。</p>
</li>
</ul>
<hr>
<h2 id="Step_8_评论系统">Step 8 评论系统</h2><ul>
<li>登录 <a href="http://duoshuo.com/" target="_blank" rel="external">http://duoshuo.com/</a> 点击我要安装，创建站点。站点地址是 Github Pages 的地址，多说域名自己填写。</li>
<li>由于 NexT 主题已经支持了多说，我们不需要添加其他代码，只需要在 <strong>_config.yml</strong> 中添加一个名为 <strong>duoshuo_shortname</strong> 的字段，其值为<strong>多说域名中自己填写的那部分</strong>，并不是全部多说域名。</li>
</ul>
<hr>
<blockquote>
<p>结语：欢迎指正交流。Aha～</p>
</blockquote>
]]></content>
    <summary type="html">
    <![CDATA[<p>看了很多博客，最后发现官方文档才是最可靠的！谨记！<br>本文只是自己尝试过程的记录，并非全部搭建方法。<br>&lt; 假设 git 已安装，Github 已注册 &gt;</p>
<blockquote>
<p>搭建环境：<br>os: Ubuntu 14.04.3 LTS<br>node: 4.2.2<br>hexo: 3.1.1<br>hexo theme: NexT<br>git: 1.9.1</p>
</blockquote>]]>
    
    </summary>
    
      <category term="Github" scheme="http://kiya-z.github.io/tags/Github/"/>
    
      <category term="Hexo" scheme="http://kiya-z.github.io/tags/Hexo/"/>
    
      <category term="Cool" scheme="http://kiya-z.github.io/categories/Cool/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Hello World]]></title>
    <link href="http://kiya-z.github.io/2015/11/09/hello-world/"/>
    <id>http://kiya-z.github.io/2015/11/09/hello-world/</id>
    <published>2015-11-09T03:11:11.000Z</published>
    <updated>2015-11-10T09:13:09.726Z</updated>
    <content type="html"><![CDATA[<p>Welcome to <a href="http://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="http://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="http://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<a id="more"></a>
<h2 id="Quick_Start">Quick Start</h2><h3 id="Create_a_new_post">Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run_server">Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate_static_files">Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy_to_remote_sites">Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<p>Welcome to <a href="http://hexo.io/">Hexo</a>! This is your very first post. Check <a href="http://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="http://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>]]>
    
    </summary>
    
  </entry>
  
</feed>
